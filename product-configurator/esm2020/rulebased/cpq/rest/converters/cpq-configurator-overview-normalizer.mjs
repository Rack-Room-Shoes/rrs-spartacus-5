/*
 * SPDX-FileCopyrightText: 2022 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { Configurator } from '@spartacus/product-configurator/rulebased';
import { take } from 'rxjs/operators';
import { Cpq } from '../cpq.models';
import * as i0 from "@angular/core";
import * as i1 from "./cpq-configurator-normalizer-utils.service";
import * as i2 from "@spartacus/core";
const INITIAL_OV_VALUE_ATTRIBUTE_NAME = '';
export class CpqConfiguratorOverviewNormalizer {
    constructor(cpqConfiguratorNormalizerUtilsService, translation) {
        this.cpqConfiguratorNormalizerUtilsService = cpqConfiguratorNormalizerUtilsService;
        this.translation = translation;
        this.NO_OPTION_SELECTED = 0;
    }
    convert(source, target) {
        const resultTarget = {
            ...target,
            configId: '',
            productCode: source.productSystemId,
            priceSummary: this.cpqConfiguratorNormalizerUtilsService.convertPriceSummary(source),
            groups: source.tabs
                ?.flatMap((tab) => this.convertTab(tab, source.currencyISOCode))
                .filter((tab) => tab.attributes && tab.attributes.length > 0),
            totalNumberOfIssues: this.calculateTotalNumberOfIssues(source),
        };
        return resultTarget;
    }
    convertTab(tab, currency) {
        let ovAttributes = [];
        tab.attributes?.forEach((attr) => {
            ovAttributes = ovAttributes.concat(this.convertAttribute(attr, currency));
        });
        const groupOverview = {
            id: tab.id.toString(),
            groupDescription: tab.displayName,
            attributes: ovAttributes,
        };
        if (groupOverview.id === '0') {
            this.translation
                .translate('configurator.group.general')
                .pipe(take(1))
                .subscribe((generalText) => (groupOverview.groupDescription = generalText));
        }
        return groupOverview;
    }
    convertAttribute(attr, currency) {
        const attributeOverviewType = attr?.values &&
            this.cpqConfiguratorNormalizerUtilsService.hasAnyProducts(attr?.values)
            ? Configurator.AttributeOverviewType.BUNDLE
            : Configurator.AttributeOverviewType.GENERAL;
        const ovAttr = [];
        this.convertAttributeValue(attr, currency).forEach((ovValue) => {
            ovAttr.push({
                ...ovValue,
                type: attributeOverviewType,
                attribute: this.cpqConfiguratorNormalizerUtilsService.convertAttributeLabel(attr),
                attributeId: attr.stdAttrCode.toString(),
            });
        });
        return ovAttr;
    }
    convertAttributeValue(attr, currency) {
        const ovValues = [];
        switch (attr.displayAs) {
            case Cpq.DisplayAs.INPUT:
                if (attr?.dataType === Cpq.DataType.INPUT_STRING) {
                    if (attr.userInput && attr.userInput.length > 0) {
                        ovValues.push(this.extractValueUserInput(attr, currency));
                    }
                }
                else {
                    ovValues.push({
                        attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
                        value: 'NOT_IMPLEMENTED',
                    });
                }
                break;
            case Cpq.DisplayAs.RADIO_BUTTON:
            case Cpq.DisplayAs.DROPDOWN:
                const selectedValue = attr.values?.find((val) => val.selected && val.paV_ID !== this.NO_OPTION_SELECTED);
                if (selectedValue) {
                    ovValues.push(this.extractValue(selectedValue, attr, currency));
                }
                break;
            case Cpq.DisplayAs.CHECK_BOX:
                attr.values
                    ?.filter((val) => val.selected)
                    ?.forEach((valueSelected) => {
                    ovValues.push(this.extractValue(valueSelected, attr, currency));
                });
                break;
            default:
                ovValues.push({
                    attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
                    value: 'NOT_IMPLEMENTED',
                });
        }
        return ovValues;
    }
    extractValue(valueSelected, attr, currency) {
        const ovValue = {
            attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
            value: valueSelected.valueDisplay ?? valueSelected.paV_ID.toString(),
            valueId: valueSelected.paV_ID.toString(),
            productCode: valueSelected.productSystemId,
            quantity: this.cpqConfiguratorNormalizerUtilsService.convertQuantity(valueSelected, attr),
            valuePrice: this.cpqConfiguratorNormalizerUtilsService.convertValuePrice(valueSelected, currency),
        };
        ovValue.valuePriceTotal =
            this.cpqConfiguratorNormalizerUtilsService.calculateValuePriceTotal(ovValue.quantity ?? 1, ovValue.valuePrice);
        return ovValue;
    }
    extractValueUserInput(attr, currency) {
        const value = attr.values ? attr.values[0] : undefined;
        const ovValue = {
            attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
            value: attr.userInput ?? attr.stdAttrCode.toString(),
            valueId: value?.paV_ID.toString(),
            quantity: 1,
        };
        if (value) {
            ovValue.valuePrice =
                this.cpqConfiguratorNormalizerUtilsService.convertValuePrice(value, currency);
            ovValue.valuePriceTotal =
                this.cpqConfiguratorNormalizerUtilsService.calculateValuePriceTotal(ovValue.quantity ?? 1, ovValue.valuePrice);
        }
        return ovValue;
    }
    calculateTotalNumberOfIssues(source) {
        let numberOfIssues = (source.incompleteAttributes?.length ?? 0) +
            (source.incompleteMessages?.length ?? 0) +
            (source.invalidMessages?.length ?? 0) +
            (source.failedValidations?.length ?? 0) +
            (source.errorMessages?.length ?? 0);
        return numberOfIssues;
    }
}
CpqConfiguratorOverviewNormalizer.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: CpqConfiguratorOverviewNormalizer, deps: [{ token: i1.CpqConfiguratorNormalizerUtilsService }, { token: i2.TranslationService }], target: i0.ɵɵFactoryTarget.Injectable });
CpqConfiguratorOverviewNormalizer.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: CpqConfiguratorOverviewNormalizer });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: CpqConfiguratorOverviewNormalizer, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.CpqConfiguratorNormalizerUtilsService }, { type: i2.TranslationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3BxLWNvbmZpZ3VyYXRvci1vdmVydmlldy1ub3JtYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL3Byb2R1Y3QtY29uZmlndXJhdG9yL3J1bGViYXNlZC9jcHEvcmVzdC9jb252ZXJ0ZXJzL2NwcS1jb25maWd1cmF0b3Itb3ZlcnZpZXctbm9ybWFsaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDekUsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxlQUFlLENBQUM7Ozs7QUFHcEMsTUFBTSwrQkFBK0IsR0FBRyxFQUFFLENBQUM7QUFHM0MsTUFBTSxPQUFPLGlDQUFpQztJQUs1QyxZQUNZLHFDQUE0RSxFQUM1RSxXQUErQjtRQUQvQiwwQ0FBcUMsR0FBckMscUNBQXFDLENBQXVDO1FBQzVFLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUp4Qix1QkFBa0IsR0FBRyxDQUFDLENBQUM7SUFLdkMsQ0FBQztJQUVKLE9BQU8sQ0FDTCxNQUF5QixFQUN6QixNQUE4QjtRQUU5QixNQUFNLFlBQVksR0FBMEI7WUFDMUMsR0FBRyxNQUFNO1lBQ1QsUUFBUSxFQUFFLEVBQUU7WUFDWixXQUFXLEVBQUUsTUFBTSxDQUFDLGVBQWU7WUFDbkMsWUFBWSxFQUNWLElBQUksQ0FBQyxxQ0FBcUMsQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUM7WUFDeEUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJO2dCQUNqQixFQUFFLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsTUFB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Q0wsUUFBUSxDQUNULENBQUM7WUFDSixPQUFPLENBQUMsZUFBZTtnQkFDckIsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLHdCQUF3QixDQUNqRSxPQUFPLENBQUMsUUFBUSxJQUFJLENBQUMsRUFDckIsT0FBTyxDQUFDLFVBQVUsQ0FDbkIsQ0FBQztTQUNMO1FBQ0QsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVTLDRCQUE0QixDQUFDLE1BQXlCO1FBQzlELElBQUksY0FBYyxHQUNoQixDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLElBQUksQ0FBQyxDQUFDO1lBQzFDLENBQUMsTUFBTSxDQUFDLGtCQUFrQixFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7WUFDeEMsQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7WUFDckMsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxJQUFJLENBQUMsQ0FBQztZQUN2QyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7OzhIQXBMVSxpQ0FBaUM7a0lBQWpDLGlDQUFpQzsyRkFBakMsaUNBQWlDO2tCQUQ3QyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjIgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udmVydGVyLCBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgQ29uZmlndXJhdG9yIH0gZnJvbSAnQHNwYXJ0YWN1cy9wcm9kdWN0LWNvbmZpZ3VyYXRvci9ydWxlYmFzZWQnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENwcSB9IGZyb20gJy4uL2NwcS5tb2RlbHMnO1xuaW1wb3J0IHsgQ3BxQ29uZmlndXJhdG9yTm9ybWFsaXplclV0aWxzU2VydmljZSB9IGZyb20gJy4vY3BxLWNvbmZpZ3VyYXRvci1ub3JtYWxpemVyLXV0aWxzLnNlcnZpY2UnO1xuXG5jb25zdCBJTklUSUFMX09WX1ZBTFVFX0FUVFJJQlVURV9OQU1FID0gJyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDcHFDb25maWd1cmF0b3JPdmVydmlld05vcm1hbGl6ZXJcbiAgaW1wbGVtZW50cyBDb252ZXJ0ZXI8Q3BxLkNvbmZpZ3VyYXRpb24sIENvbmZpZ3VyYXRvci5PdmVydmlldz5cbntcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IE5PX09QVElPTl9TRUxFQ1RFRCA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2U6IENwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2VcbiAgKSB7fVxuXG4gIGNvbnZlcnQoXG4gICAgc291cmNlOiBDcHEuQ29uZmlndXJhdGlvbixcbiAgICB0YXJnZXQ/OiBDb25maWd1cmF0b3IuT3ZlcnZpZXdcbiAgKTogQ29uZmlndXJhdG9yLk92ZXJ2aWV3IHtcbiAgICBjb25zdCByZXN1bHRUYXJnZXQ6IENvbmZpZ3VyYXRvci5PdmVydmlldyA9IHtcbiAgICAgIC4uLnRhcmdldCxcbiAgICAgIGNvbmZpZ0lkOiAnJyxcbiAgICAgIHByb2R1Y3RDb2RlOiBzb3VyY2UucHJvZHVjdFN5c3RlbUlkLFxuICAgICAgcHJpY2VTdW1tYXJ5OlxuICAgICAgICB0aGlzLmNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UuY29udmVydFByaWNlU3VtbWFyeShzb3VyY2UpLFxuICAgICAgZ3JvdXBzOiBzb3VyY2UudGFic1xuICAgICAgICA/LmZsYXRNYXAoKHRhYikgPT4gdGhpcy5jb252ZXJ0VGFiKHRhYiwgc291cmNlLmN1cnJlbmN5SVNPQ29kZSkpXG4gICAgICAgIC5maWx0ZXIoKHRhYikgPT4gdGFiLmF0dHJpYnV0ZXMgJiYgdGFiLmF0dHJpYnV0ZXMubGVuZ3RoID4gMCksXG4gICAgICB0b3RhbE51bWJlck9mSXNzdWVzOiB0aGlzLmNhbGN1bGF0ZVRvdGFsTnVtYmVyT2ZJc3N1ZXMoc291cmNlKSxcbiAgICB9O1xuICAgIHJldHVybiByZXN1bHRUYXJnZXQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgY29udmVydFRhYihcbiAgICB0YWI6IENwcS5UYWIsXG4gICAgY3VycmVuY3k6IHN0cmluZ1xuICApOiBDb25maWd1cmF0b3IuR3JvdXBPdmVydmlldyB7XG4gICAgbGV0IG92QXR0cmlidXRlczogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3W10gPSBbXTtcbiAgICB0YWIuYXR0cmlidXRlcz8uZm9yRWFjaCgoYXR0cikgPT4ge1xuICAgICAgb3ZBdHRyaWJ1dGVzID0gb3ZBdHRyaWJ1dGVzLmNvbmNhdCh0aGlzLmNvbnZlcnRBdHRyaWJ1dGUoYXR0ciwgY3VycmVuY3kpKTtcbiAgICB9KTtcbiAgICBjb25zdCBncm91cE92ZXJ2aWV3OiBDb25maWd1cmF0b3IuR3JvdXBPdmVydmlldyA9IHtcbiAgICAgIGlkOiB0YWIuaWQudG9TdHJpbmcoKSxcbiAgICAgIGdyb3VwRGVzY3JpcHRpb246IHRhYi5kaXNwbGF5TmFtZSxcbiAgICAgIGF0dHJpYnV0ZXM6IG92QXR0cmlidXRlcyxcbiAgICB9O1xuICAgIGlmIChncm91cE92ZXJ2aWV3LmlkID09PSAnMCcpIHtcbiAgICAgIHRoaXMudHJhbnNsYXRpb25cbiAgICAgICAgLnRyYW5zbGF0ZSgnY29uZmlndXJhdG9yLmdyb3VwLmdlbmVyYWwnKVxuICAgICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgICAuc3Vic2NyaWJlKFxuICAgICAgICAgIChnZW5lcmFsVGV4dCkgPT4gKGdyb3VwT3ZlcnZpZXcuZ3JvdXBEZXNjcmlwdGlvbiA9IGdlbmVyYWxUZXh0KVxuICAgICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gZ3JvdXBPdmVydmlldztcbiAgfVxuXG4gIHByb3RlY3RlZCBjb252ZXJ0QXR0cmlidXRlKFxuICAgIGF0dHI6IENwcS5BdHRyaWJ1dGUsXG4gICAgY3VycmVuY3k6IHN0cmluZ1xuICApOiBDb25maWd1cmF0b3IuQXR0cmlidXRlT3ZlcnZpZXdbXSB7XG4gICAgY29uc3QgYXR0cmlidXRlT3ZlcnZpZXdUeXBlOiBDb25maWd1cmF0b3IuQXR0cmlidXRlT3ZlcnZpZXdUeXBlID1cbiAgICAgIGF0dHI/LnZhbHVlcyAmJlxuICAgICAgdGhpcy5jcHFDb25maWd1cmF0b3JOb3JtYWxpemVyVXRpbHNTZXJ2aWNlLmhhc0FueVByb2R1Y3RzKGF0dHI/LnZhbHVlcylcbiAgICAgICAgPyBDb25maWd1cmF0b3IuQXR0cmlidXRlT3ZlcnZpZXdUeXBlLkJVTkRMRVxuICAgICAgICA6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlld1R5cGUuR0VORVJBTDtcbiAgICBjb25zdCBvdkF0dHI6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlld1tdID0gW107XG4gICAgdGhpcy5jb252ZXJ0QXR0cmlidXRlVmFsdWUoYXR0ciwgY3VycmVuY3kpLmZvckVhY2goKG92VmFsdWUpID0+IHtcbiAgICAgIG92QXR0ci5wdXNoKHtcbiAgICAgICAgLi4ub3ZWYWx1ZSxcbiAgICAgICAgdHlwZTogYXR0cmlidXRlT3ZlcnZpZXdUeXBlLFxuICAgICAgICBhdHRyaWJ1dGU6XG4gICAgICAgICAgdGhpcy5jcHFDb25maWd1cmF0b3JOb3JtYWxpemVyVXRpbHNTZXJ2aWNlLmNvbnZlcnRBdHRyaWJ1dGVMYWJlbChcbiAgICAgICAgICAgIGF0dHJcbiAgICAgICAgICApLFxuICAgICAgICBhdHRyaWJ1dGVJZDogYXR0ci5zdGRBdHRyQ29kZS50b1N0cmluZygpLFxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIG92QXR0cjtcbiAgfVxuXG4gIHByb3RlY3RlZCBjb252ZXJ0QXR0cmlidXRlVmFsdWUoXG4gICAgYXR0cjogQ3BxLkF0dHJpYnV0ZSxcbiAgICBjdXJyZW5jeTogc3RyaW5nXG4gICk6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlld1tdIHtcbiAgICBjb25zdCBvdlZhbHVlczogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3W10gPSBbXTtcbiAgICBzd2l0Y2ggKGF0dHIuZGlzcGxheUFzKSB7XG4gICAgICBjYXNlIENwcS5EaXNwbGF5QXMuSU5QVVQ6XG4gICAgICAgIGlmIChhdHRyPy5kYXRhVHlwZSA9PT0gQ3BxLkRhdGFUeXBlLklOUFVUX1NUUklORykge1xuICAgICAgICAgIGlmIChhdHRyLnVzZXJJbnB1dCAmJiBhdHRyLnVzZXJJbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBvdlZhbHVlcy5wdXNoKHRoaXMuZXh0cmFjdFZhbHVlVXNlcklucHV0KGF0dHIsIGN1cnJlbmN5KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG92VmFsdWVzLnB1c2goe1xuICAgICAgICAgICAgYXR0cmlidXRlOiBJTklUSUFMX09WX1ZBTFVFX0FUVFJJQlVURV9OQU1FLFxuICAgICAgICAgICAgdmFsdWU6ICdOT1RfSU1QTEVNRU5URUQnLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBDcHEuRGlzcGxheUFzLlJBRElPX0JVVFRPTjpcbiAgICAgIGNhc2UgQ3BxLkRpc3BsYXlBcy5EUk9QRE9XTjpcbiAgICAgICAgY29uc3Qgc2VsZWN0ZWRWYWx1ZSA9IGF0dHIudmFsdWVzPy5maW5kKFxuICAgICAgICAgICh2YWwpID0+IHZhbC5zZWxlY3RlZCAmJiB2YWwucGFWX0lEICE9PSB0aGlzLk5PX09QVElPTl9TRUxFQ1RFRFxuICAgICAgICApO1xuICAgICAgICBpZiAoc2VsZWN0ZWRWYWx1ZSkge1xuICAgICAgICAgIG92VmFsdWVzLnB1c2godGhpcy5leHRyYWN0VmFsdWUoc2VsZWN0ZWRWYWx1ZSwgYXR0ciwgY3VycmVuY3kpKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgQ3BxLkRpc3BsYXlBcy5DSEVDS19CT1g6XG4gICAgICAgIGF0dHIudmFsdWVzXG4gICAgICAgICAgPy5maWx0ZXIoKHZhbCkgPT4gdmFsLnNlbGVjdGVkKVxuICAgICAgICAgID8uZm9yRWFjaCgodmFsdWVTZWxlY3RlZCkgPT4ge1xuICAgICAgICAgICAgb3ZWYWx1ZXMucHVzaCh0aGlzLmV4dHJhY3RWYWx1ZSh2YWx1ZVNlbGVjdGVkLCBhdHRyLCBjdXJyZW5jeSkpO1xuICAgICAgICAgIH0pO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIG92VmFsdWVzLnB1c2goe1xuICAgICAgICAgIGF0dHJpYnV0ZTogSU5JVElBTF9PVl9WQUxVRV9BVFRSSUJVVEVfTkFNRSxcbiAgICAgICAgICB2YWx1ZTogJ05PVF9JTVBMRU1FTlRFRCcsXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gb3ZWYWx1ZXM7XG4gIH1cblxuICBwcm90ZWN0ZWQgZXh0cmFjdFZhbHVlKFxuICAgIHZhbHVlU2VsZWN0ZWQ6IENwcS5WYWx1ZSxcbiAgICBhdHRyOiBDcHEuQXR0cmlidXRlLFxuICAgIGN1cnJlbmN5OiBzdHJpbmdcbiAgKTogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3IHtcbiAgICBjb25zdCBvdlZhbHVlOiBDb25maWd1cmF0b3IuQXR0cmlidXRlT3ZlcnZpZXcgPSB7XG4gICAgICBhdHRyaWJ1dGU6IElOSVRJQUxfT1ZfVkFMVUVfQVRUUklCVVRFX05BTUUsXG4gICAgICB2YWx1ZTogdmFsdWVTZWxlY3RlZC52YWx1ZURpc3BsYXkgPz8gdmFsdWVTZWxlY3RlZC5wYVZfSUQudG9TdHJpbmcoKSxcbiAgICAgIHZhbHVlSWQ6IHZhbHVlU2VsZWN0ZWQucGFWX0lELnRvU3RyaW5nKCksXG4gICAgICBwcm9kdWN0Q29kZTogdmFsdWVTZWxlY3RlZC5wcm9kdWN0U3lzdGVtSWQsXG4gICAgICBxdWFudGl0eTogdGhpcy5jcHFDb25maWd1cmF0b3JOb3JtYWxpemVyVXRpbHNTZXJ2aWNlLmNvbnZlcnRRdWFudGl0eShcbiAgICAgICAgdmFsdWVTZWxlY3RlZCxcbiAgICAgICAgYXR0clxuICAgICAgKSxcbiAgICAgIHZhbHVlUHJpY2U6IHRoaXMuY3BxQ29uZmlndXJhdG9yTm9ybWFsaXplclV0aWxzU2VydmljZS5jb252ZXJ0VmFsdWVQcmljZShcbiAgICAgICAgdmFsdWVTZWxlY3RlZCxcbiAgICAgICAgY3VycmVuY3lcbiAgICAgICksXG4gICAgfTtcbiAgICBvdlZhbHVlLnZhbHVlUHJpY2VUb3RhbCA9XG4gICAgICB0aGlzLmNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UuY2FsY3VsYXRlVmFsdWVQcmljZVRvdGFsKFxuICAgICAgICBvdlZhbHVlLnF1YW50aXR5ID8/IDEsXG4gICAgICAgIG92VmFsdWUudmFsdWVQcmljZVxuICAgICAgKTtcbiAgICByZXR1cm4gb3ZWYWx1ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBleHRyYWN0VmFsdWVVc2VySW5wdXQoXG4gICAgYXR0cjogQ3BxLkF0dHJpYnV0ZSxcbiAgICBjdXJyZW5jeTogc3RyaW5nXG4gICk6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlldyB7XG4gICAgY29uc3QgdmFsdWUgPSBhdHRyLnZhbHVlcyA/IGF0dHIudmFsdWVzWzBdIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IG92VmFsdWU6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlldyA9IHtcbiAgICAgIGF0dHJpYnV0ZTogSU5JVElBTF9PVl9WQUxVRV9BVFRSSUJVVEVfTkFNRSxcbiAgICAgIHZhbHVlOiBhdHRyLnVzZXJJbnB1dCA/PyBhdHRyLnN0ZEF0dHJDb2RlLnRvU3RyaW5nKCksXG4gICAgICB2YWx1ZUlkOiB2YWx1ZT8ucGFWX0lELnRvU3RyaW5nKCksXG4gICAgICBxdWFudGl0eTogMSxcbiAgICB9O1xuICAgIGlmICh2YWx1ZSkge1xuICAgICAgb3ZWYWx1ZS52YWx1ZVByaWNlID1cbiAgICAgICAgdGhpcy5jcHFDb25maWd1cmF0b3JOb3JtYWxpemVyVXRpbHNTZXJ2aWNlLmNvbnZlcnRWYWx1ZVByaWNlKFxuICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgIGN1cnJlbmN5XG4gICAgICAgICk7XG4gICAgICBvdlZhbHVlLnZhbHVlUHJpY2VUb3RhbCA9XG4gICAgICAgIHRoaXMuY3BxQ29uZmlndXJhdG9yTm9ybWFsaXplclV0aWxzU2VydmljZS5jYWxjdWxhdGVWYWx1ZVByaWNlVG90YWwoXG4gICAgICAgICAgb3ZWYWx1ZS5xdWFudGl0eSA/PyAxLFxuICAgICAgICAgIG92VmFsdWUudmFsdWVQcmljZVxuICAgICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gb3ZWYWx1ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjYWxjdWxhdGVUb3RhbE51bWJlck9mSXNzdWVzKHNvdXJjZTogQ3BxLkNvbmZpZ3VyYXRpb24pOiBudW1iZXIge1xuICAgIGxldCBudW1iZXJPZklzc3VlczogbnVtYmVyID1cbiAgICAgIChzb3VyY2UuaW5jb21wbGV0ZUF0dHJpYnV0ZXM/Lmxlbmd0aCA/PyAwKSArXG4gICAgICAoc291cmNlLmluY29tcGxldGVNZXNzYWdlcz8ubGVuZ3RoID8/IDApICtcbiAgICAgIChzb3VyY2UuaW52YWxpZE1lc3NhZ2VzPy5sZW5ndGggPz8gMCkgK1xuICAgICAgKHNvdXJjZS5mYWlsZWRWYWxpZGF0aW9ucz8ubGVuZ3RoID8/IDApICtcbiAgICAgIChzb3VyY2UuZXJyb3JNZXNzYWdlcz8ubGVuZ3RoID8/IDApO1xuICAgIHJldHVybiBudW1iZXJPZklzc3VlcztcbiAgfVxufVxuIl19
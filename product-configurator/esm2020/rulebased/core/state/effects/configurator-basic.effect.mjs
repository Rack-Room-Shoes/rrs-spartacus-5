/*
 * SPDX-FileCopyrightText: 2022 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { select } from '@ngrx/store';
import { normalizeHttpError } from '@spartacus/core';
import { catchError, filter, map, mergeMap, switchMap, switchMapTo, take, } from 'rxjs/operators';
import { ConfiguratorActions } from '../actions/index';
import { ConfiguratorSelectors } from '../selectors/index';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "../../connectors/rulebased-configurator.connector";
import * as i3 from "@spartacus/product-configurator/common";
import * as i4 from "../../facade/utils/configurator-utils.service";
import * as i5 from "../../facade/configurator-group-status.service";
import * as i6 from "@ngrx/store";
import * as i7 from "./configurator-basic-effect.service";
/**
 * Common configurator effects, used for complex configurators like variant configurator
 * and CPQ
 */
export class ConfiguratorBasicEffects {
    constructor(actions$, configuratorCommonsConnector, commonConfigUtilsService, configuratorGroupUtilsService, configuratorGroupStatusService, store, configuratorBasicEffectService) {
        this.actions$ = actions$;
        this.configuratorCommonsConnector = configuratorCommonsConnector;
        this.commonConfigUtilsService = commonConfigUtilsService;
        this.configuratorGroupUtilsService = configuratorGroupUtilsService;
        this.configuratorGroupStatusService = configuratorGroupStatusService;
        this.store = store;
        this.configuratorBasicEffectService = configuratorBasicEffectService;
        this.createConfiguration$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.CREATE_CONFIGURATION), mergeMap((action) => {
            return this.configuratorCommonsConnector
                .createConfiguration(action.payload)
                .pipe(switchMap((configuration) => {
                const currentGroup = this.configuratorBasicEffectService.getFirstGroupWithAttributes(configuration);
                this.store.dispatch(new ConfiguratorActions.UpdatePriceSummary({
                    ...configuration,
                    interactionState: { currentGroup: currentGroup },
                }));
                return [
                    new ConfiguratorActions.CreateConfigurationSuccess(configuration),
                ];
            }), catchError((error) => [
                new ConfiguratorActions.CreateConfigurationFail({
                    ownerKey: action.payload.key,
                    error: normalizeHttpError(error),
                }),
            ]));
        })));
        this.readConfiguration$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.READ_CONFIGURATION), mergeMap((action) => {
            return this.configuratorCommonsConnector
                .readConfiguration(action.payload.configuration.configId, action.payload.groupId, action.payload.configuration.owner)
                .pipe(switchMap((configuration) => {
                return [
                    new ConfiguratorActions.ReadConfigurationSuccess(configuration),
                ];
            }), catchError((error) => [
                new ConfiguratorActions.ReadConfigurationFail({
                    ownerKey: action.payload.configuration.owner.key,
                    error: normalizeHttpError(error),
                }),
            ]));
        })));
        this.updateConfiguration$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.UPDATE_CONFIGURATION), map((action) => action.payload), 
        //mergeMap here as we need to process each update
        //(which only sends one changed attribute at a time),
        //so we must not cancel inner emissions
        mergeMap((payload) => {
            return this.configuratorCommonsConnector
                .updateConfiguration(payload)
                .pipe(map((configuration) => {
                return new ConfiguratorActions.UpdateConfigurationSuccess(configuration);
            }), catchError((error) => {
                const errorPayload = normalizeHttpError(error);
                return [
                    new ConfiguratorActions.UpdateConfigurationFail({
                        configuration: payload,
                        error: errorPayload,
                    }),
                ];
            }));
        })));
        this.updatePriceSummary$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.UPDATE_PRICE_SUMMARY), map((action) => action.payload), mergeMap((payload) => {
            return this.configuratorCommonsConnector.readPriceSummary(payload).pipe(map((configuration) => {
                return new ConfiguratorActions.UpdatePriceSummarySuccess(configuration);
            }), catchError((error) => {
                const errorPayload = normalizeHttpError(error);
                return [
                    new ConfiguratorActions.UpdatePriceSummaryFail({
                        ownerKey: payload.owner.key,
                        error: errorPayload,
                    }),
                ];
            }));
        })));
        this.getOverview$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.GET_CONFIGURATION_OVERVIEW), map((action) => action.payload), mergeMap((payload) => {
            return this.configuratorCommonsConnector
                .getConfigurationOverview(payload)
                .pipe(map((overview) => {
                return new ConfiguratorActions.GetConfigurationOverviewSuccess({
                    ownerKey: payload.owner.key,
                    overview: overview,
                });
            }), catchError((error) => {
                const errorPayload = normalizeHttpError(error);
                return [
                    new ConfiguratorActions.GetConfigurationOverviewFail({
                        ownerKey: payload.owner.key,
                        error: errorPayload,
                    }),
                ];
            }));
        })));
        this.updateConfigurationSuccess$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.UPDATE_CONFIGURATION_SUCCESS), map((action) => action.payload), mergeMap((payload) => {
            return this.store.pipe(select(ConfiguratorSelectors.hasPendingChanges(payload.owner.key)), take(1), filter((hasPendingChanges) => hasPendingChanges === false), switchMapTo(this.store.pipe(select(ConfiguratorSelectors.getCurrentGroup(payload.owner.key)), take(1), map((currentGroupId) => {
                const groupIdFromPayload = this.configuratorBasicEffectService.getFirstGroupWithAttributes(payload);
                const parentGroupFromPayload = this.configuratorGroupUtilsService.getParentGroup(payload.groups, this.configuratorGroupUtilsService.getGroupById(payload.groups, groupIdFromPayload), undefined);
                return {
                    currentGroupId,
                    groupIdFromPayload,
                    parentGroupFromPayload,
                };
            }), switchMap((container) => {
                //changeGroup because in cases where a queue of updates exists with a group navigation in between,
                //we need to ensure that the last update determines the current group.
                const updateFinalizeSuccessAction = new ConfiguratorActions.UpdateConfigurationFinalizeSuccess(payload);
                const updatePriceSummaryAction = new ConfiguratorActions.UpdatePriceSummary({
                    ...payload,
                    interactionState: {
                        currentGroup: container.groupIdFromPayload,
                    },
                });
                return container.currentGroupId === container.groupIdFromPayload
                    ? [updateFinalizeSuccessAction, updatePriceSummaryAction]
                    : [
                        updateFinalizeSuccessAction,
                        updatePriceSummaryAction,
                        new ConfiguratorActions.ChangeGroup({
                            configuration: payload,
                            groupId: container.groupIdFromPayload,
                            parentGroupId: container.parentGroupFromPayload?.id,
                        }),
                    ];
            }))));
        })));
        this.updateConfigurationFail$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.UPDATE_CONFIGURATION_FAIL), map((action) => action.payload), mergeMap((payload) => {
            return this.store.pipe(select(ConfiguratorSelectors.hasPendingChanges(payload.configuration.owner.key)), take(1), filter((hasPendingChanges) => hasPendingChanges === false), map(() => new ConfiguratorActions.UpdateConfigurationFinalizeFail(payload.configuration)));
        })));
        this.handleErrorOnUpdate$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.UPDATE_CONFIGURATION_FINALIZE_FAIL), map((action) => action.payload), map((payload) => new ConfiguratorActions.ReadConfiguration({
            configuration: payload,
            groupId: this.configuratorBasicEffectService.getFirstGroupWithAttributes(payload),
        }))));
        this.groupChange$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorActions.CHANGE_GROUP), switchMap((action) => {
            return this.store.pipe(select(ConfiguratorSelectors.hasPendingChanges(action.payload.configuration.owner.key)), take(1), filter((hasPendingChanges) => hasPendingChanges === false), switchMap(() => {
                return this.configuratorCommonsConnector
                    .readConfiguration(action.payload.configuration.configId, action.payload.groupId, action.payload.configuration.owner)
                    .pipe(switchMap((configuration) => {
                    return [
                        new ConfiguratorActions.SetCurrentGroup({
                            entityKey: action.payload.configuration.owner.key,
                            currentGroup: action.payload.groupId,
                        }),
                        new ConfiguratorActions.SetMenuParentGroup({
                            entityKey: action.payload.configuration.owner.key,
                            menuParentGroup: action.payload.parentGroupId,
                        }),
                        new ConfiguratorActions.ReadConfigurationSuccess(configuration),
                        new ConfiguratorActions.UpdatePriceSummary({
                            ...configuration,
                            interactionState: {
                                currentGroup: action.payload.groupId,
                            },
                        }),
                    ];
                }), catchError((error) => [
                    new ConfiguratorActions.ReadConfigurationFail({
                        ownerKey: action.payload.configuration.owner.key,
                        error: normalizeHttpError(error),
                    }),
                ]));
            }));
        })));
    }
}
ConfiguratorBasicEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ConfiguratorBasicEffects, deps: [{ token: i1.Actions }, { token: i2.RulebasedConfiguratorConnector }, { token: i3.CommonConfiguratorUtilsService }, { token: i4.ConfiguratorUtilsService }, { token: i5.ConfiguratorGroupStatusService }, { token: i6.Store }, { token: i7.ConfiguratorBasicEffectService }], target: i0.ɵɵFactoryTarget.Injectable });
ConfiguratorBasicEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ConfiguratorBasicEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: ConfiguratorBasicEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.RulebasedConfiguratorConnector }, { type: i3.CommonConfiguratorUtilsService }, { type: i4.ConfiguratorUtilsService }, { type: i5.ConfiguratorGroupStatusService }, { type: i6.Store }, { type: i7.ConfiguratorBasicEffectService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJhdG9yLWJhc2ljLmVmZmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9wcm9kdWN0LWNvbmZpZ3VyYXRvci9ydWxlYmFzZWQvY29yZS9zdGF0ZS9lZmZlY3RzL2NvbmZpZ3VyYXRvci1iYXNpYy5lZmZlY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFXLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBUyxNQUFNLGFBQWEsQ0FBQztBQUM1QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUdyRCxPQUFPLEVBQ0wsVUFBVSxFQUNWLE1BQU0sRUFDTixHQUFHLEVBQ0gsUUFBUSxFQUNSLFNBQVMsRUFDVCxXQUFXLEVBQ1gsSUFBSSxHQUNMLE1BQU0sZ0JBQWdCLENBQUM7QUFLeEIsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFdkQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7Ozs7Ozs7OztBQUkzRDs7O0dBR0c7QUFDSCxNQUFNLE9BQU8sd0JBQXdCO0lBOFZuQyxZQUNZLFFBQWlCLEVBQ2pCLDRCQUE0RCxFQUM1RCx3QkFBd0QsRUFDeEQsNkJBQXVELEVBQ3ZELDhCQUE4RCxFQUM5RCxLQUFtQyxFQUNuQyw4QkFBOEQ7UUFOOUQsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQixpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQWdDO1FBQzVELDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBZ0M7UUFDeEQsa0NBQTZCLEdBQTdCLDZCQUE2QixDQUEwQjtRQUN2RCxtQ0FBOEIsR0FBOUIsOEJBQThCLENBQWdDO1FBQzlELFVB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QUFRLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUc7d0JBQ2hELEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxLQUFLLENBQUM7cUJBQ2pDLENBQUM7aUJBQ0gsQ0FBQyxDQUNILENBQUM7WUFDTixDQUFDLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FDRixDQUFDO0lBVUMsQ0FBQzs7cUhBdFdPLHdCQUF3Qjt5SEFBeEIsd0JBQXdCOzJGQUF4Qix3QkFBd0I7a0JBTHBDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMiBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25zLCBjcmVhdGVFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHsgc2VsZWN0LCBTdG9yZSB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcbmltcG9ydCB7IG5vcm1hbGl6ZUh0dHBFcnJvciB9IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBDb21tb25Db25maWd1cmF0b3JVdGlsc1NlcnZpY2UgfSBmcm9tICdAc3BhcnRhY3VzL3Byb2R1Y3QtY29uZmlndXJhdG9yL2NvbW1vbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBjYXRjaEVycm9yLFxuICBmaWx0ZXIsXG4gIG1hcCxcbiAgbWVyZ2VNYXAsXG4gIHN3aXRjaE1hcCxcbiAgc3dpdGNoTWFwVG8sXG4gIHRha2UsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJ1bGViYXNlZENvbmZpZ3VyYXRvckNvbm5lY3RvciB9IGZyb20gJy4uLy4uL2Nvbm5lY3RvcnMvcnVsZWJhc2VkLWNvbmZpZ3VyYXRvci5jb25uZWN0b3InO1xuaW1wb3J0IHsgQ29uZmlndXJhdG9yR3JvdXBTdGF0dXNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vZmFjYWRlL2NvbmZpZ3VyYXRvci1ncm91cC1zdGF0dXMuc2VydmljZSc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JVdGlsc1NlcnZpY2UgfSBmcm9tICcuLi8uLi9mYWNhZGUvdXRpbHMvY29uZmlndXJhdG9yLXV0aWxzLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29uZmlndXJhdG9yIH0gZnJvbSAnLi4vLi4vbW9kZWwvY29uZmlndXJhdG9yLm1vZGVsJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvckFjdGlvbnMgfSBmcm9tICcuLi9hY3Rpb25zL2luZGV4JztcbmltcG9ydCB7IFN0YXRlV2l0aENvbmZpZ3VyYXRvciB9IGZyb20gJy4uL2NvbmZpZ3VyYXRvci1zdGF0ZSc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JTZWxlY3RvcnMgfSBmcm9tICcuLi9zZWxlY3RvcnMvaW5kZXgnO1xuaW1wb3J0IHsgQ29uZmlndXJhdG9yQmFzaWNFZmZlY3RTZXJ2aWNlIH0gZnJvbSAnLi9jb25maWd1cmF0b3ItYmFzaWMtZWZmZWN0LnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG4vKipcbiAqIENvbW1vbiBjb25maWd1cmF0b3IgZWZmZWN0cywgdXNlZCBmb3IgY29tcGxleCBjb25maWd1cmF0b3JzIGxpa2UgdmFyaWFudCBjb25maWd1cmF0b3JcbiAqIGFuZCBDUFFcbiAqL1xuZXhwb3J0IGNsYXNzIENvbmZpZ3VyYXRvckJhc2ljRWZmZWN0cyB7XG4gIGNyZWF0ZUNvbmZpZ3VyYXRpb24kOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5DcmVhdGVDb25maWd1cmF0aW9uU3VjY2Vzc1xuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5DcmVhdGVDb25maWd1cmF0aW9uRmFpbFxuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKENvbmZpZ3VyYXRvckFjdGlvbnMuQ1JFQVRFX0NPTkZJR1VSQVRJT04pLFxuICAgICAgbWVyZ2VNYXAoKGFjdGlvbjogQ29uZmlndXJhdG9yQWN0aW9ucy5DcmVhdGVDb25maWd1cmF0aW9uKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3VyYXRvckNvbW1vbnNDb25uZWN0b3JcbiAgICAgICAgICAuY3JlYXRlQ29uZmlndXJhdGlvbihhY3Rpb24ucGF5bG9hZClcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoY29uZmlndXJhdGlvbjogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgY3VycmVudEdyb3VwID1cbiAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRvckJhc2ljRWZmZWN0U2VydmljZS5nZXRGaXJzdEdyb3VwV2l0aEF0dHJpYnV0ZXMoXG4gICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yQWN0aW9ucy5VcGRhdGVQcmljZVN1bW1hcnkoe1xuICAgICAgICAgICAgICAgICAgLi4uY29uZmlndXJhdGlvbixcbiAgICAgICAgICAgICAgICAgIGludGVyYWN0aW9uU3RhdGU6IHsgY3VycmVudEdyb3VwOiBjdXJyZW50R3JvdXAgfSxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuQ3JlYXRlQ29uZmlndXJhdGlvblN1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IFtcbiAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuQ3JlYXRlQ29uZmlndXJhdGlvbkZhaWwoe1xuICAgICAgICAgICAgICAgIG93bmVyS2V5OiBhY3Rpb24ucGF5bG9hZC5rZXksXG4gICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciksXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgXSlcbiAgICAgICAgICApO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgcmVhZENvbmZpZ3VyYXRpb24kOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5SZWFkQ29uZmlndXJhdGlvblN1Y2Nlc3NcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuUmVhZENvbmZpZ3VyYXRpb25GYWlsXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29uZmlndXJhdG9yQWN0aW9ucy5SRUFEX0NPTkZJR1VSQVRJT04pLFxuXG4gICAgICBtZXJnZU1hcCgoYWN0aW9uOiBDb25maWd1cmF0b3JBY3Rpb25zLlJlYWRDb25maWd1cmF0aW9uKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3VyYXRvckNvbW1vbnNDb25uZWN0b3JcbiAgICAgICAgICAucmVhZENvbmZpZ3VyYXRpb24oXG4gICAgICAgICAgICBhY3Rpb24ucGF5bG9hZC5jb25maWd1cmF0aW9uLmNvbmZpZ0lkLFxuICAgICAgICAgICAgYWN0aW9uLnBheWxvYWQuZ3JvdXBJZCxcbiAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkLmNvbmZpZ3VyYXRpb24ub3duZXJcbiAgICAgICAgICApXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGNvbmZpZ3VyYXRpb246IENvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuUmVhZENvbmZpZ3VyYXRpb25TdWNjZXNzKGNvbmZpZ3VyYXRpb24pLFxuICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT4gW1xuICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yQWN0aW9ucy5SZWFkQ29uZmlndXJhdGlvbkZhaWwoe1xuICAgICAgICAgICAgICAgIG93bmVyS2V5OiBhY3Rpb24ucGF5bG9hZC5jb25maWd1cmF0aW9uLm93bmVyLmtleSxcbiAgICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yKSxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBdKVxuICAgICAgICAgICk7XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICB1cGRhdGVDb25maWd1cmF0aW9uJDogT2JzZXJ2YWJsZTxcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlQ29uZmlndXJhdGlvblN1Y2Nlc3NcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlQ29uZmlndXJhdGlvbkZhaWxcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShDb25maWd1cmF0b3JBY3Rpb25zLlVQREFURV9DT05GSUdVUkFUSU9OKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBDb25maWd1cmF0b3JBY3Rpb25zLlVwZGF0ZUNvbmZpZ3VyYXRpb24pID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICAgIC8vbWVyZ2VNYXAgaGVyZSBhcyB3ZSBuZWVkIHRvIHByb2Nlc3MgZWFjaCB1cGRhdGVcbiAgICAgIC8vKHdoaWNoIG9ubHkgc2VuZHMgb25lIGNoYW5nZWQgYXR0cmlidXRlIGF0IGEgdGltZSksXG4gICAgICAvL3NvIHdlIG11c3Qgbm90IGNhbmNlbCBpbm5lciBlbWlzc2lvbnNcbiAgICAgIG1lcmdlTWFwKChwYXlsb2FkOiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbikgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25maWd1cmF0b3JDb21tb25zQ29ubmVjdG9yXG4gICAgICAgICAgLnVwZGF0ZUNvbmZpZ3VyYXRpb24ocGF5bG9hZClcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIG1hcCgoY29uZmlndXJhdGlvbjogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDb25maWd1cmF0b3JBY3Rpb25zLlVwZGF0ZUNvbmZpZ3VyYXRpb25TdWNjZXNzKFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb25cbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgZXJyb3JQYXlsb2FkID0gbm9ybWFsaXplSHR0cEVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yQWN0aW9ucy5VcGRhdGVDb25maWd1cmF0aW9uRmFpbCh7XG4gICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uOiBwYXlsb2FkLFxuICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yUGF5bG9hZCxcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIHVwZGF0ZVByaWNlU3VtbWFyeSQ6IE9ic2VydmFibGU8XG4gICAgfCBDb25maWd1cmF0b3JBY3Rpb25zLlVwZGF0ZVByaWNlU3VtbWFyeVN1Y2Nlc3NcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlUHJpY2VTdW1tYXJ5RmFpbFxuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKENvbmZpZ3VyYXRvckFjdGlvbnMuVVBEQVRFX1BSSUNFX1NVTU1BUlkpLFxuICAgICAgbWFwKFxuICAgICAgICAoYWN0aW9uOiB7IHR5cGU6IHN0cmluZzsgcGF5bG9hZDogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24gfSkgPT5cbiAgICAgICAgICBhY3Rpb24ucGF5bG9hZFxuICAgICAgKSxcbiAgICAgIG1lcmdlTWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3VyYXRvckNvbW1vbnNDb25uZWN0b3IucmVhZFByaWNlU3VtbWFyeShwYXlsb2FkKS5waXBlKFxuICAgICAgICAgIG1hcCgoY29uZmlndXJhdGlvbjogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ29uZmlndXJhdG9yQWN0aW9ucy5VcGRhdGVQcmljZVN1bW1hcnlTdWNjZXNzKFxuICAgICAgICAgICAgICBjb25maWd1cmF0aW9uXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBlcnJvclBheWxvYWQgPSBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IpO1xuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlUHJpY2VTdW1tYXJ5RmFpbCh7XG4gICAgICAgICAgICAgICAgb3duZXJLZXk6IHBheWxvYWQub3duZXIua2V5LFxuICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvclBheWxvYWQsXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgXTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgZ2V0T3ZlcnZpZXckOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5HZXRDb25maWd1cmF0aW9uT3ZlcnZpZXdTdWNjZXNzXG4gICAgfCBDb25maWd1cmF0b3JBY3Rpb25zLkdldENvbmZpZ3VyYXRpb25PdmVydmlld0ZhaWxcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShDb25maWd1cmF0b3JBY3Rpb25zLkdFVF9DT05GSUdVUkFUSU9OX09WRVJWSUVXKSxcbiAgICAgIG1hcChcbiAgICAgICAgKGFjdGlvbjogQ29uZmlndXJhdG9yQWN0aW9ucy5HZXRDb25maWd1cmF0aW9uT3ZlcnZpZXcpID0+IGFjdGlvbi5wYXlsb2FkXG4gICAgICApLFxuICAgICAgbWVyZ2VNYXAoKHBheWxvYWQpID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlndXJhdG9yQ29tbW9uc0Nvbm5lY3RvclxuICAgICAgICAgIC5nZXRDb25maWd1cmF0aW9uT3ZlcnZpZXcocGF5bG9hZClcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIG1hcCgob3ZlcnZpZXc6IENvbmZpZ3VyYXRvci5PdmVydmlldykgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuR2V0Q29uZmlndXJhdGlvbk92ZXJ2aWV3U3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgb3duZXJLZXk6IHBheWxvYWQub3duZXIua2V5LFxuICAgICAgICAgICAgICAgIG92ZXJ2aWV3OiBvdmVydmlldyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGVycm9yUGF5bG9hZCA9IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvcik7XG4gICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuR2V0Q29uZmlndXJhdGlvbk92ZXJ2aWV3RmFpbCh7XG4gICAgICAgICAgICAgICAgICBvd25lcktleTogcGF5bG9hZC5vd25lci5rZXksXG4gICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3JQYXlsb2FkLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgdXBkYXRlQ29uZmlndXJhdGlvblN1Y2Nlc3MkOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5VcGRhdGVDb25maWd1cmF0aW9uRmluYWxpemVTdWNjZXNzXG4gICAgfCBDb25maWd1cmF0b3JBY3Rpb25zLlVwZGF0ZVByaWNlU3VtbWFyeVxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5DaGFuZ2VHcm91cFxuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKENvbmZpZ3VyYXRvckFjdGlvbnMuVVBEQVRFX0NPTkZJR1VSQVRJT05fU1VDQ0VTUyksXG4gICAgICBtYXAoXG4gICAgICAgIChhY3Rpb246IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlQ29uZmlndXJhdGlvblN1Y2Nlc3MpID0+XG4gICAgICAgICAgYWN0aW9uLnBheWxvYWRcbiAgICAgICksXG4gICAgICBtZXJnZU1hcCgocGF5bG9hZDogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgICAgICBzZWxlY3QoQ29uZmlndXJhdG9yU2VsZWN0b3JzLmhhc1BlbmRpbmdDaGFuZ2VzKHBheWxvYWQub3duZXIua2V5KSksXG4gICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICBmaWx0ZXIoKGhhc1BlbmRpbmdDaGFuZ2VzKSA9PiBoYXNQZW5kaW5nQ2hhbmdlcyA9PT0gZmFsc2UpLFxuICAgICAgICAgIHN3aXRjaE1hcFRvKFxuICAgICAgICAgICAgdGhpcy5zdG9yZS5waXBlKFxuICAgICAgICAgICAgICBzZWxlY3QoQ29uZmlndXJhdG9yU2VsZWN0b3JzLmdldEN1cnJlbnRHcm91cChwYXlsb2FkLm93bmVyLmtleSkpLFxuICAgICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgICBtYXAoKGN1cnJlbnRHcm91cElkKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBJZEZyb21QYXlsb2FkID1cbiAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlndXJhdG9yQmFzaWNFZmZlY3RTZXJ2aWNlLmdldEZpcnN0R3JvdXBXaXRoQXR0cmlidXRlcyhcbiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZFxuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRHcm91cEZyb21QYXlsb2FkID1cbiAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlndXJhdG9yR3JvdXBVdGlsc1NlcnZpY2UuZ2V0UGFyZW50R3JvdXAoXG4gICAgICAgICAgICAgICAgICAgIHBheWxvYWQuZ3JvdXBzLFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRvckdyb3VwVXRpbHNTZXJ2aWNlLmdldEdyb3VwQnlJZChcbiAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLmdyb3VwcyxcbiAgICAgICAgICAgICAgICAgICAgICBncm91cElkRnJvbVBheWxvYWRcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICAgdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICBjdXJyZW50R3JvdXBJZCxcbiAgICAgICAgICAgICAgICAgIGdyb3VwSWRGcm9tUGF5bG9hZCxcbiAgICAgICAgICAgICAgICAgIHBhcmVudEdyb3VwRnJvbVBheWxvYWQsXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIHN3aXRjaE1hcCgoY29udGFpbmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgLy9jaGFuZ2VHcm91cCBiZWNhdXNlIGluIGNhc2VzIHdoZXJlIGEgcXVldWUgb2YgdXBkYXRlcyBleGlzdHMgd2l0aCBhIGdyb3VwIG5hdmlnYXRpb24gaW4gYmV0d2VlbixcbiAgICAgICAgICAgICAgICAvL3dlIG5lZWQgdG8gZW5zdXJlIHRoYXQgdGhlIGxhc3QgdXBkYXRlIGRldGVybWluZXMgdGhlIGN1cnJlbnQgZ3JvdXAuXG4gICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlRmluYWxpemVTdWNjZXNzQWN0aW9uID1cbiAgICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JBY3Rpb25zLlVwZGF0ZUNvbmZpZ3VyYXRpb25GaW5hbGl6ZVN1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgICAgIHBheWxvYWRcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlUHJpY2VTdW1tYXJ5QWN0aW9uID1cbiAgICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JBY3Rpb25zLlVwZGF0ZVByaWNlU3VtbWFyeSh7XG4gICAgICAgICAgICAgICAgICAgIC4uLnBheWxvYWQsXG4gICAgICAgICAgICAgICAgICAgIGludGVyYWN0aW9uU3RhdGU6IHtcbiAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50R3JvdXA6IGNvbnRhaW5lci5ncm91cElkRnJvbVBheWxvYWQsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29udGFpbmVyLmN1cnJlbnRHcm91cElkID09PSBjb250YWluZXIuZ3JvdXBJZEZyb21QYXlsb2FkXG4gICAgICAgICAgICAgICAgICA/IFt1cGRhdGVGaW5hbGl6ZVN1Y2Nlc3NBY3Rpb24sIHVwZGF0ZVByaWNlU3VtbWFyeUFjdGlvbl1cbiAgICAgICAgICAgICAgICAgIDogW1xuICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUZpbmFsaXplU3VjY2Vzc0FjdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVQcmljZVN1bW1hcnlBY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuQ2hhbmdlR3JvdXAoe1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbjogcGF5bG9hZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwSWQ6IGNvbnRhaW5lci5ncm91cElkRnJvbVBheWxvYWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRHcm91cElkOiBjb250YWluZXIucGFyZW50R3JvdXBGcm9tUGF5bG9hZD8uaWQsXG4gICAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIF07XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgdXBkYXRlQ29uZmlndXJhdGlvbkZhaWwkOiBPYnNlcnZhYmxlPENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlQ29uZmlndXJhdGlvbkZpbmFsaXplRmFpbD4gPVxuICAgIGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgICBvZlR5cGUoQ29uZmlndXJhdG9yQWN0aW9ucy5VUERBVEVfQ09ORklHVVJBVElPTl9GQUlMKSxcbiAgICAgICAgbWFwKFxuICAgICAgICAgIChhY3Rpb246IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlQ29uZmlndXJhdGlvbkZhaWwpID0+XG4gICAgICAgICAgICBhY3Rpb24ucGF5bG9hZFxuICAgICAgICApLFxuICAgICAgICBtZXJnZU1hcCgocGF5bG9hZCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICAgICAgICBzZWxlY3QoXG4gICAgICAgICAgICAgIENvbmZpZ3VyYXRvclNlbGVjdG9ycy5oYXNQZW5kaW5nQ2hhbmdlcyhcbiAgICAgICAgICAgICAgICBwYXlsb2FkLmNvbmZpZ3VyYXRpb24ub3duZXIua2V5XG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgICAgZmlsdGVyKChoYXNQZW5kaW5nQ2hhbmdlcykgPT4gaGFzUGVuZGluZ0NoYW5nZXMgPT09IGZhbHNlKSxcbiAgICAgICAgICAgIG1hcChcbiAgICAgICAgICAgICAgKCkgPT5cbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yQWN0aW9ucy5VcGRhdGVDb25maWd1cmF0aW9uRmluYWxpemVGYWlsKFxuICAgICAgICAgICAgICAgICAgcGF5bG9hZC5jb25maWd1cmF0aW9uXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKTtcblxuICBoYW5kbGVFcnJvck9uVXBkYXRlJDogT2JzZXJ2YWJsZTxDb25maWd1cmF0b3JBY3Rpb25zLlJlYWRDb25maWd1cmF0aW9uPiA9XG4gICAgY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICAgIG9mVHlwZShDb25maWd1cmF0b3JBY3Rpb25zLlVQREFURV9DT05GSUdVUkFUSU9OX0ZJTkFMSVpFX0ZBSUwpLFxuICAgICAgICBtYXAoXG4gICAgICAgICAgKGFjdGlvbjogQ29uZmlndXJhdG9yQWN0aW9ucy5VcGRhdGVDb25maWd1cmF0aW9uRmluYWxpemVGYWlsKSA9PlxuICAgICAgICAgICAgYWN0aW9uLnBheWxvYWRcbiAgICAgICAgKSxcbiAgICAgICAgbWFwKFxuICAgICAgICAgIChwYXlsb2FkKSA9PlxuICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuUmVhZENvbmZpZ3VyYXRpb24oe1xuICAgICAgICAgICAgICBjb25maWd1cmF0aW9uOiBwYXlsb2FkLFxuICAgICAgICAgICAgICBncm91cElkOlxuICAgICAgICAgICAgICAgIHRoaXMuY29uZmlndXJhdG9yQmFzaWNFZmZlY3RTZXJ2aWNlLmdldEZpcnN0R3JvdXBXaXRoQXR0cmlidXRlcyhcbiAgICAgICAgICAgICAgICAgIHBheWxvYWRcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG5cbiAgZ3JvdXBDaGFuZ2UkOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5TZXRDdXJyZW50R3JvdXBcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuU2V0TWVudVBhcmVudEdyb3VwXG4gICAgfCBDb25maWd1cmF0b3JBY3Rpb25zLlJlYWRDb25maWd1cmF0aW9uRmFpbFxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5SZWFkQ29uZmlndXJhdGlvblN1Y2Nlc3NcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlUHJpY2VTdW1tYXJ5XG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29uZmlndXJhdG9yQWN0aW9ucy5DSEFOR0VfR1JPVVApLFxuICAgICAgc3dpdGNoTWFwKChhY3Rpb246IENvbmZpZ3VyYXRvckFjdGlvbnMuQ2hhbmdlR3JvdXApID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmUucGlwZShcbiAgICAgICAgICBzZWxlY3QoXG4gICAgICAgICAgICBDb25maWd1cmF0b3JTZWxlY3RvcnMuaGFzUGVuZGluZ0NoYW5nZXMoXG4gICAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkLmNvbmZpZ3VyYXRpb24ub3duZXIua2V5XG4gICAgICAgICAgICApXG4gICAgICAgICAgKSxcbiAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgIGZpbHRlcigoaGFzUGVuZGluZ0NoYW5nZXMpID0+IGhhc1BlbmRpbmdDaGFuZ2VzID09PSBmYWxzZSksXG4gICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3VyYXRvckNvbW1vbnNDb25uZWN0b3JcbiAgICAgICAgICAgICAgLnJlYWRDb25maWd1cmF0aW9uKFxuICAgICAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkLmNvbmZpZ3VyYXRpb24uY29uZmlnSWQsXG4gICAgICAgICAgICAgICAgYWN0aW9uLnBheWxvYWQuZ3JvdXBJZCxcbiAgICAgICAgICAgICAgICBhY3Rpb24ucGF5bG9hZC5jb25maWd1cmF0aW9uLm93bmVyXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgc3dpdGNoTWFwKChjb25maWd1cmF0aW9uOiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbikgPT4ge1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuU2V0Q3VycmVudEdyb3VwKHtcbiAgICAgICAgICAgICAgICAgICAgICBlbnRpdHlLZXk6IGFjdGlvbi5wYXlsb2FkLmNvbmZpZ3VyYXRpb24ub3duZXIua2V5LFxuICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRHcm91cDogYWN0aW9uLnBheWxvYWQuZ3JvdXBJZCxcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JBY3Rpb25zLlNldE1lbnVQYXJlbnRHcm91cCh7XG4gICAgICAgICAgICAgICAgICAgICAgZW50aXR5S2V5OiBhY3Rpb24ucGF5bG9hZC5jb25maWd1cmF0aW9uLm93bmVyLmtleSxcbiAgICAgICAgICAgICAgICAgICAgICBtZW51UGFyZW50R3JvdXA6IGFjdGlvbi5wYXlsb2FkLnBhcmVudEdyb3VwSWQsXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yQWN0aW9ucy5SZWFkQ29uZmlndXJhdGlvblN1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvblxuICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yQWN0aW9ucy5VcGRhdGVQcmljZVN1bW1hcnkoe1xuICAgICAgICAgICAgICAgICAgICAgIC4uLmNvbmZpZ3VyYXRpb24sXG4gICAgICAgICAgICAgICAgICAgICAgaW50ZXJhY3Rpb25TdGF0ZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEdyb3VwOiBhY3Rpb24ucGF5bG9hZC5ncm91cElkLFxuICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT4gW1xuICAgICAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvckFjdGlvbnMuUmVhZENvbmZpZ3VyYXRpb25GYWlsKHtcbiAgICAgICAgICAgICAgICAgICAgb3duZXJLZXk6IGFjdGlvbi5wYXlsb2FkLmNvbmZpZ3VyYXRpb24ub3duZXIua2V5LFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yKSxcbiAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIF0pXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBhY3Rpb25zJDogQWN0aW9ucyxcbiAgICBwcm90ZWN0ZWQgY29uZmlndXJhdG9yQ29tbW9uc0Nvbm5lY3RvcjogUnVsZWJhc2VkQ29uZmlndXJhdG9yQ29ubmVjdG9yLFxuICAgIHByb3RlY3RlZCBjb21tb25Db25maWdVdGlsc1NlcnZpY2U6IENvbW1vbkNvbmZpZ3VyYXRvclV0aWxzU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgY29uZmlndXJhdG9yR3JvdXBVdGlsc1NlcnZpY2U6IENvbmZpZ3VyYXRvclV0aWxzU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgY29uZmlndXJhdG9yR3JvdXBTdGF0dXNTZXJ2aWNlOiBDb25maWd1cmF0b3JHcm91cFN0YXR1c1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHN0b3JlOiBTdG9yZTxTdGF0ZVdpdGhDb25maWd1cmF0b3I+LFxuICAgIHByb3RlY3RlZCBjb25maWd1cmF0b3JCYXNpY0VmZmVjdFNlcnZpY2U6IENvbmZpZ3VyYXRvckJhc2ljRWZmZWN0U2VydmljZVxuICApIHt9XG59XG4iXX0=
/*
 * SPDX-FileCopyrightText: 2022 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { CommonConfigurator, ConfiguratorModelUtils, } from '@spartacus/product-configurator/common';
import { ConfiguratorActions } from '../actions/index';
import { ConfiguratorStateUtils } from '../configurator-state-utils';
export const initialState = {
    configId: '',
    productCode: '',
    groups: [],
    flatGroups: [],
    interactionState: {
        currentGroup: undefined,
        groupsVisited: {},
        menuParentGroup: undefined,
    },
    owner: ConfiguratorModelUtils.createInitialOwner(),
};
export const initialStatePendingChanges = 0;
export function configuratorReducer(state = initialState, action) {
    switch (action.type) {
        case ConfiguratorActions.UPDATE_CONFIGURATION_FINALIZE_SUCCESS: {
            const result = takeOverChanges(action, state);
            result.isCartEntryUpdateRequired = true;
            result.overview = undefined;
            return result;
        }
        case ConfiguratorActions.UPDATE_CART_ENTRY: {
            const result = { ...state };
            result.isCartEntryUpdateRequired = false;
            return result;
        }
        case ConfiguratorActions.CREATE_CONFIGURATION_SUCCESS:
        case ConfiguratorActions.READ_CONFIGURATION_SUCCESS:
        case ConfiguratorActions.READ_CART_ENTRY_CONFIGURATION_SUCCESS: {
            return setInitialCurrentGroup(takeOverChanges(action, state));
        }
        case ConfiguratorActions.UPDATE_PRICE_SUMMARY_SUCCESS: {
            return setInitialCurrentGroup(takeOverPricingChanges(action, state));
        }
        case ConfiguratorActions.GET_CONFIGURATION_OVERVIEW_SUCCESS: {
            const content = { ...action.payload.overview };
            const result = {
                ...state,
                overview: content,
                priceSummary: content.priceSummary,
                interactionState: {
                    ...state.interactionState,
                    issueNavigationDone: false,
                },
            };
            return result;
        }
        case ConfiguratorActions.READ_ORDER_ENTRY_CONFIGURATION_SUCCESS: {
            const configuration = { ...action.payload };
            const result = {
                ...state,
                ...configuration,
                priceSummary: configuration.overview?.priceSummary,
            };
            return result;
        }
        case ConfiguratorActions.SET_NEXT_OWNER_CART_ENTRY: {
            const content = { ...action.payload.configuration };
            content.nextOwner = ConfiguratorModelUtils.createOwner(CommonConfigurator.OwnerType.CART_ENTRY, action.payload.cartEntryNo);
            const result = {
                ...state,
                ...content,
            };
            return result;
        }
        case ConfiguratorActions.SET_INTERACTION_STATE: {
            const newInteractionState = action.payload.interactionState;
            return {
                ...state,
                interactionState: newInteractionState,
            };
        }
        case ConfiguratorActions.SET_CURRENT_GROUP: {
            const newCurrentGroup = action.payload.currentGroup;
            return {
                ...state,
                interactionState: {
                    ...state.interactionState,
                    currentGroup: newCurrentGroup,
                },
            };
        }
        case ConfiguratorActions.SET_MENU_PARENT_GROUP: {
            const newMenuParentGroup = action.payload.menuParentGroup;
            return {
                ...state,
                interactionState: {
                    ...state.interactionState,
                    menuParentGroup: newMenuParentGroup,
                },
            };
        }
        case ConfiguratorActions.SET_GROUPS_VISITED: {
            const groupIds = action.payload.visitedGroups;
            const changedInteractionState = {
                groupsVisited: {},
            };
            //Set Current state items
            if (state.interactionState.groupsVisited) {
                Object.keys(state.interactionState.groupsVisited).forEach((groupId) => setGroupsVisited(changedInteractionState, groupId));
            }
            //Add new Groups
            groupIds.forEach((groupId) => setGroupsVisited(changedInteractionState, groupId));
            return {
                ...state,
                interactionState: {
                    ...state.interactionState,
                    groupsVisited: changedInteractionState.groupsVisited,
                },
            };
        }
    }
    return state;
}
function setGroupsVisited(changedInteractionState, groupId) {
    const groupsVisited = changedInteractionState.groupsVisited;
    if (groupsVisited) {
        groupsVisited[groupId] = true;
    }
}
function setInitialCurrentGroup(state) {
    if (state.interactionState.currentGroup) {
        return state;
    }
    let initialCurrentGroup;
    const flatGroups = state.flatGroups;
    if (flatGroups && flatGroups.length > 0) {
        initialCurrentGroup = flatGroups[0]?.id;
    }
    const result = {
        ...state,
        interactionState: {
            ...state.interactionState,
            currentGroup: initialCurrentGroup,
        },
    };
    return result;
}
function takeOverChanges(action, state) {
    const content = { ...action.payload };
    const groups = content.groups.length > 0 ? content.groups : state.groups;
    const result = {
        ...state,
        ...content,
        groups: groups,
        interactionState: {
            ...state.interactionState,
            ...content.interactionState,
            issueNavigationDone: true,
        },
    };
    return result;
}
function takeOverPricingChanges(action, state) {
    const content = { ...action.payload };
    const priceSupplements = content.priceSupplements;
    const groups = priceSupplements && priceSupplements.length > 0
        ? ConfiguratorStateUtils.mergeGroupsWithSupplements(state.groups, priceSupplements)
        : state.groups;
    const result = {
        ...state,
        ...content,
        groups: groups,
        interactionState: {
            ...state.interactionState,
            ...content.interactionState,
            issueNavigationDone: true,
        },
    };
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJhdG9yLnJlZHVjZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcHJvZHVjdC1jb25maWd1cmF0b3IvcnVsZWJhc2VkL2NvcmUvc3RhdGUvcmVkdWNlcnMvY29uZmlndXJhdG9yLnJlZHVjZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFDTCxrQkFBa0IsRUFDbEIsc0JBQXNCLEdBQ3ZCLE1BQU0sd0NBQXdDLENBQUM7QUFFaEQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDdkQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFckUsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUErQjtJQUN0RCxRQUFRLEVBQUUsRUFBRTtJQUNaLFdBQVcsRUFBRSxFQUFFO0lBQ2YsTUFBTSxFQUFFLEVBQUU7SUFDVixVQUFVLEVBQUUsRUFBRTtJQUNkLGdCQUFnQixFQUFFO1FBQ2hCLFlBQVksRUFBRSxTQUFTO1FBQ3ZCLGFBQWEsRUFBRSxFQUFFO1FBQ2pCLGVBQWUsRUFBRSxTQUFTO0tBQzNCO0lBQ0QsS0FBSyxFQUFFLHNCQUFzQixDQUFDLGtCQUFrQixFQUFFO0NBQ25ELENBQUM7QUFDRixNQUFNLENBQUMsTUFBTSwwQkFBMEIsR0FBRyxDQUFDLENBQUM7QUFFNUMsTUFBTSxVQUFVLG1CQUFtQixDQUNqQyxLQUFLLEdBQUcsWUFBWSxFQUNwQixNQUU4QztJQUU5QyxRQUFRLE1BQU0sQ0FBQyxJQUFJLEVBQUU7UUFDbkIsS0FBSyxtQkFBbUIsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1lBQzlELE1BQU0sTUFBTSxHQUErQixlQUFlLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzFFLE1BQU0sQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLENBQUM7WUFDeEMsTUFBTSxDQUFDLFFB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QUFNLE9BQU8sR0FBRyxFQUFFLEdBQUcsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3RDLE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDO0lBQ2xELE1BQU0sTUFBTSxHQUNWLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDO1FBQzdDLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQywwQkFBMEIsQ0FDL0MsS0FBSyxDQUFDLE1BQU0sRUFDWixnQkFBZ0IsQ0FDakI7UUFDSCxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUVuQixNQUFNLE1BQU0sR0FBRztRQUNiLEdBQUcsS0FBSztRQUNSLEdBQUcsT0FBTztRQUNWLE1BQU0sRUFBRSxNQUFNO1FBQ2QsZ0JBQWdCLEVBQUU7WUFDaEIsR0FBRyxLQUFLLENBQUMsZ0JBQWdCO1lBQ3pCLEdBQUcsT0FBTyxDQUFDLGdCQUFnQjtZQUMzQixtQkFBbUIsRUFBRSxJQUFJO1NBQzFCO0tBQ0YsQ0FBQztJQUNGLE9BQU8sTUFBTSxDQUFDO0FBQ2hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMiBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQge1xuICBDb21tb25Db25maWd1cmF0b3IsXG4gIENvbmZpZ3VyYXRvck1vZGVsVXRpbHMsXG59IGZyb20gJ0BzcGFydGFjdXMvcHJvZHVjdC1jb25maWd1cmF0b3IvY29tbW9uJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvciB9IGZyb20gJy4uLy4uL21vZGVsL2NvbmZpZ3VyYXRvci5tb2RlbCc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JBY3Rpb25zIH0gZnJvbSAnLi4vYWN0aW9ucy9pbmRleCc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JTdGF0ZVV0aWxzIH0gZnJvbSAnLi4vY29uZmlndXJhdG9yLXN0YXRlLXV0aWxzJztcblxuZXhwb3J0IGNvbnN0IGluaXRpYWxTdGF0ZTogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24gPSB7XG4gIGNvbmZpZ0lkOiAnJyxcbiAgcHJvZHVjdENvZGU6ICcnLFxuICBncm91cHM6IFtdLFxuICBmbGF0R3JvdXBzOiBbXSxcbiAgaW50ZXJhY3Rpb25TdGF0ZToge1xuICAgIGN1cnJlbnRHcm91cDogdW5kZWZpbmVkLFxuICAgIGdyb3Vwc1Zpc2l0ZWQ6IHt9LFxuICAgIG1lbnVQYXJlbnRHcm91cDogdW5kZWZpbmVkLFxuICB9LFxuICBvd25lcjogQ29uZmlndXJhdG9yTW9kZWxVdGlscy5jcmVhdGVJbml0aWFsT3duZXIoKSxcbn07XG5leHBvcnQgY29uc3QgaW5pdGlhbFN0YXRlUGVuZGluZ0NoYW5nZXMgPSAwO1xuXG5leHBvcnQgZnVuY3Rpb24gY29uZmlndXJhdG9yUmVkdWNlcihcbiAgc3RhdGUgPSBpbml0aWFsU3RhdGUsXG4gIGFjdGlvbjpcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuQ29uZmlndXJhdG9yQWN0aW9uXG4gICAgfCBDb25maWd1cmF0b3JBY3Rpb25zLkNvbmZpZ3VyYXRvckNhcnRBY3Rpb25cbik6IENvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uIHtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgQ29uZmlndXJhdG9yQWN0aW9ucy5VUERBVEVfQ09ORklHVVJBVElPTl9GSU5BTElaRV9TVUNDRVNTOiB7XG4gICAgICBjb25zdCByZXN1bHQ6IENvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uID0gdGFrZU92ZXJDaGFuZ2VzKGFjdGlvbiwgc3RhdGUpO1xuICAgICAgcmVzdWx0LmlzQ2FydEVudHJ5VXBkYXRlUmVxdWlyZWQgPSB0cnVlO1xuICAgICAgcmVzdWx0Lm92ZXJ2aWV3ID0gdW5kZWZpbmVkO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgY2FzZSBDb25maWd1cmF0b3JBY3Rpb25zLlVQREFURV9DQVJUX0VOVFJZOiB7XG4gICAgICBjb25zdCByZXN1bHQgPSB7IC4uLnN0YXRlIH07XG4gICAgICByZXN1bHQuaXNDYXJ0RW50cnlVcGRhdGVSZXF1aXJlZCA9IGZhbHNlO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgY2FzZSBDb25maWd1cmF0b3JBY3Rpb25zLkNSRUFURV9DT05GSUdVUkFUSU9OX1NVQ0NFU1M6XG4gICAgY2FzZSBDb25maWd1cmF0b3JBY3Rpb25zLlJFQURfQ09ORklHVVJBVElPTl9TVUNDRVNTOlxuICAgIGNhc2UgQ29uZmlndXJhdG9yQWN0aW9ucy5SRUFEX0NBUlRfRU5UUllfQ09ORklHVVJBVElPTl9TVUNDRVNTOiB7XG4gICAgICByZXR1cm4gc2V0SW5pdGlhbEN1cnJlbnRHcm91cCh0YWtlT3ZlckNoYW5nZXMoYWN0aW9uLCBzdGF0ZSkpO1xuICAgIH1cblxuICAgIGNhc2UgQ29uZmlndXJhdG9yQWN0aW9ucy5VUERBVEVfUFJJQ0VfU1VNTUFSWV9TVUNDRVNTOiB7XG4gICAgICByZXR1cm4gc2V0SW5pdGlhbEN1cnJlbnRHcm91cCh0YWtlT3ZlclByaWNpbmdDaGFuZ2VzKGFjdGlvbiwgc3RhdGUpKTtcbiAgICB9XG5cbiAgICBjYXNlIENvbmZpZ3VyYXRvckFjdGlvbnMuR0VUX0NPTkZJR1VSQVRJT05fT1ZFUlZJRVdfU1VDQ0VTUzoge1xuICAgICAgY29uc3QgY29udGVudCA9IHsgLi4uYWN0aW9uLnBheWxvYWQub3ZlcnZpZXcgfTtcblxuICAgICAgY29uc3QgcmVzdWx0OiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIG92ZXJ2aWV3OiBjb250ZW50LFxuICAgICAgICBwcmljZVN1bW1hcnk6IGNvbnRlbnQucHJpY2VTdW1tYXJ5LFxuICAgICAgICBpbnRlcmFjdGlvblN0YXRlOiB7XG4gICAgICAgICAgLi4uc3RhdGUuaW50ZXJhY3Rpb25TdGF0ZSxcbiAgICAgICAgICBpc3N1ZU5hdmlnYXRpb25Eb25lOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgIH07XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIGNhc2UgQ29uZmlndXJhdG9yQWN0aW9ucy5SRUFEX09SREVSX0VOVFJZX0NPTkZJR1VSQVRJT05fU1VDQ0VTUzoge1xuICAgICAgY29uc3QgY29uZmlndXJhdGlvbiA9IHsgLi4uYWN0aW9uLnBheWxvYWQgfTtcblxuICAgICAgY29uc3QgcmVzdWx0OiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIC4uLmNvbmZpZ3VyYXRpb24sXG4gICAgICAgIHByaWNlU3VtbWFyeTogY29uZmlndXJhdGlvbi5vdmVydmlldz8ucHJpY2VTdW1tYXJ5LFxuICAgICAgfTtcblxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgY2FzZSBDb25maWd1cmF0b3JBY3Rpb25zLlNFVF9ORVhUX09XTkVSX0NBUlRfRU5UUlk6IHtcbiAgICAgIGNvbnN0IGNvbnRlbnQgPSB7IC4uLmFjdGlvbi5wYXlsb2FkLmNvbmZpZ3VyYXRpb24gfTtcbiAgICAgIGNvbnRlbnQubmV4dE93bmVyID0gQ29uZmlndXJhdG9yTW9kZWxVdGlscy5jcmVhdGVPd25lcihcbiAgICAgICAgQ29tbW9uQ29uZmlndXJhdG9yLk93bmVyVHlwZS5DQVJUX0VOVFJZLFxuICAgICAgICBhY3Rpb24ucGF5bG9hZC5jYXJ0RW50cnlOb1xuICAgICAgKTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIC4uLmNvbnRlbnQsXG4gICAgICB9O1xuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICBjYXNlIENvbmZpZ3VyYXRvckFjdGlvbnMuU0VUX0lOVEVSQUNUSU9OX1NUQVRFOiB7XG4gICAgICBjb25zdCBuZXdJbnRlcmFjdGlvblN0YXRlOiBDb25maWd1cmF0b3IuSW50ZXJhY3Rpb25TdGF0ZSA9XG4gICAgICAgIGFjdGlvbi5wYXlsb2FkLmludGVyYWN0aW9uU3RhdGU7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBpbnRlcmFjdGlvblN0YXRlOiBuZXdJbnRlcmFjdGlvblN0YXRlLFxuICAgICAgfTtcbiAgICB9XG4gICAgY2FzZSBDb25maWd1cmF0b3JBY3Rpb25zLlNFVF9DVVJSRU5UX0dST1VQOiB7XG4gICAgICBjb25zdCBuZXdDdXJyZW50R3JvdXA6IHN0cmluZyA9IGFjdGlvbi5wYXlsb2FkLmN1cnJlbnRHcm91cDtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGludGVyYWN0aW9uU3RhdGU6IHtcbiAgICAgICAgICAuLi5zdGF0ZS5pbnRlcmFjdGlvblN0YXRlLFxuICAgICAgICAgIGN1cnJlbnRHcm91cDogbmV3Q3VycmVudEdyb3VwLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG4gICAgY2FzZSBDb25maWd1cmF0b3JBY3Rpb25zLlNFVF9NRU5VX1BBUkVOVF9HUk9VUDoge1xuICAgICAgY29uc3QgbmV3TWVudVBhcmVudEdyb3VwID0gYWN0aW9uLnBheWxvYWQubWVudVBhcmVudEdyb3VwO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgaW50ZXJhY3Rpb25TdGF0ZToge1xuICAgICAgICAgIC4uLnN0YXRlLmludGVyYWN0aW9uU3RhdGUsXG4gICAgICAgICAgbWVudVBhcmVudEdyb3VwOiBuZXdNZW51UGFyZW50R3JvdXAsXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgIH1cbiAgICBjYXNlIENvbmZpZ3VyYXRvckFjdGlvbnMuU0VUX0dST1VQU19WSVNJVEVEOiB7XG4gICAgICBjb25zdCBncm91cElkczogc3RyaW5nW10gPSBhY3Rpb24ucGF5bG9hZC52aXNpdGVkR3JvdXBzO1xuXG4gICAgICBjb25zdCBjaGFuZ2VkSW50ZXJhY3Rpb25TdGF0ZTogQ29uZmlndXJhdG9yLkludGVyYWN0aW9uU3RhdGUgPSB7XG4gICAgICAgIGdyb3Vwc1Zpc2l0ZWQ6IHt9LFxuICAgICAgfTtcblxuICAgICAgLy9TZXQgQ3VycmVudCBzdGF0ZSBpdGVtc1xuICAgICAgaWYgKHN0YXRlLmludGVyYWN0aW9uU3RhdGUuZ3JvdXBzVmlzaXRlZCkge1xuICAgICAgICBPYmplY3Qua2V5cyhzdGF0ZS5pbnRlcmFjdGlvblN0YXRlLmdyb3Vwc1Zpc2l0ZWQpLmZvckVhY2goKGdyb3VwSWQpID0+XG4gICAgICAgICAgc2V0R3JvdXBzVmlzaXRlZChjaGFuZ2VkSW50ZXJhY3Rpb25TdGF0ZSwgZ3JvdXBJZClcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy9BZGQgbmV3IEdyb3Vwc1xuICAgICAgZ3JvdXBJZHMuZm9yRWFjaCgoZ3JvdXBJZCkgPT5cbiAgICAgICAgc2V0R3JvdXBzVmlzaXRlZChjaGFuZ2VkSW50ZXJhY3Rpb25TdGF0ZSwgZ3JvdXBJZClcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIC4uLnN0YXRlLFxuICAgICAgICBpbnRlcmFjdGlvblN0YXRlOiB7XG4gICAgICAgICAgLi4uc3RhdGUuaW50ZXJhY3Rpb25TdGF0ZSxcbiAgICAgICAgICBncm91cHNWaXNpdGVkOiBjaGFuZ2VkSW50ZXJhY3Rpb25TdGF0ZS5ncm91cHNWaXNpdGVkLFxuICAgICAgICB9LFxuICAgICAgfTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBzZXRHcm91cHNWaXNpdGVkKFxuICBjaGFuZ2VkSW50ZXJhY3Rpb25TdGF0ZTogQ29uZmlndXJhdG9yLkludGVyYWN0aW9uU3RhdGUsXG4gIGdyb3VwSWQ6IHN0cmluZ1xuKSB7XG4gIGNvbnN0IGdyb3Vwc1Zpc2l0ZWQgPSBjaGFuZ2VkSW50ZXJhY3Rpb25TdGF0ZS5ncm91cHNWaXNpdGVkO1xuICBpZiAoZ3JvdXBzVmlzaXRlZCkge1xuICAgIGdyb3Vwc1Zpc2l0ZWRbZ3JvdXBJZF0gPSB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNldEluaXRpYWxDdXJyZW50R3JvdXAoXG4gIHN0YXRlOiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvblxuKTogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24ge1xuICBpZiAoc3RhdGUuaW50ZXJhY3Rpb25TdGF0ZS5jdXJyZW50R3JvdXApIHtcbiAgICByZXR1cm4gc3RhdGU7XG4gIH1cbiAgbGV0IGluaXRpYWxDdXJyZW50R3JvdXA7XG4gIGNvbnN0IGZsYXRHcm91cHMgPSBzdGF0ZS5mbGF0R3JvdXBzO1xuICBpZiAoZmxhdEdyb3VwcyAmJiBmbGF0R3JvdXBzLmxlbmd0aCA+IDApIHtcbiAgICBpbml0aWFsQ3VycmVudEdyb3VwID0gZmxhdEdyb3Vwc1swXT8uaWQ7XG4gIH1cblxuICBjb25zdCByZXN1bHQgPSB7XG4gICAgLi4uc3RhdGUsXG4gICAgaW50ZXJhY3Rpb25TdGF0ZToge1xuICAgICAgLi4uc3RhdGUuaW50ZXJhY3Rpb25TdGF0ZSxcbiAgICAgIGN1cnJlbnRHcm91cDogaW5pdGlhbEN1cnJlbnRHcm91cCxcbiAgICB9LFxuICB9O1xuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIHRha2VPdmVyQ2hhbmdlcyhcbiAgYWN0aW9uOlxuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5DcmVhdGVDb25maWd1cmF0aW9uU3VjY2Vzc1xuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5SZWFkQ29uZmlndXJhdGlvblN1Y2Nlc3NcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuVXBkYXRlQ29uZmlndXJhdGlvbkZpbmFsaXplU3VjY2Vzc1xuICAgIHwgQ29uZmlndXJhdG9yQWN0aW9ucy5SZWFkQ2FydEVudHJ5Q29uZmlndXJhdGlvblN1Y2Nlc3NcbiAgICB8IENvbmZpZ3VyYXRvckFjdGlvbnMuUmVhZE9yZGVyRW50cnlDb25maWd1cmF0aW9uU3VjY2VzcyxcbiAgc3RhdGU6IENvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uXG4pOiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbiB7XG4gIGNvbnN0IGNvbnRlbnQgPSB7IC4uLmFjdGlvbi5wYXlsb2FkIH07XG4gIGNvbnN0IGdyb3VwcyA9IGNvbnRlbnQuZ3JvdXBzLmxlbmd0aCA+IDAgPyBjb250ZW50Lmdyb3VwcyA6IHN0YXRlLmdyb3VwcztcblxuICBjb25zdCByZXN1bHQ6IENvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uID0ge1xuICAgIC4uLnN0YXRlLFxuICAgIC4uLmNvbnRlbnQsXG4gICAgZ3JvdXBzOiBncm91cHMsXG4gICAgaW50ZXJhY3Rpb25TdGF0ZToge1xuICAgICAgLi4uc3RhdGUuaW50ZXJhY3Rpb25TdGF0ZSxcbiAgICAgIC4uLmNvbnRlbnQuaW50ZXJhY3Rpb25TdGF0ZSxcbiAgICAgIGlzc3VlTmF2aWdhdGlvbkRvbmU6IHRydWUsXG4gICAgfSxcbiAgfTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gdGFrZU92ZXJQcmljaW5nQ2hhbmdlcyhcbiAgYWN0aW9uOiBDb25maWd1cmF0b3JBY3Rpb25zLlVwZGF0ZVByaWNlU3VtbWFyeVN1Y2Nlc3MsXG4gIHN0YXRlOiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvblxuKTogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24ge1xuICBjb25zdCBjb250ZW50ID0geyAuLi5hY3Rpb24ucGF5bG9hZCB9O1xuICBjb25zdCBwcmljZVN1cHBsZW1lbnRzID0gY29udGVudC5wcmljZVN1cHBsZW1lbnRzO1xuICBjb25zdCBncm91cHMgPVxuICAgIHByaWNlU3VwcGxlbWVudHMgJiYgcHJpY2VTdXBwbGVtZW50cy5sZW5ndGggPiAwXG4gICAgICA/IENvbmZpZ3VyYXRvclN0YXRlVXRpbHMubWVyZ2VHcm91cHNXaXRoU3VwcGxlbWVudHMoXG4gICAgICAgICAgc3RhdGUuZ3JvdXBzLFxuICAgICAgICAgIHByaWNlU3VwcGxlbWVudHNcbiAgICAgICAgKVxuICAgICAgOiBzdGF0ZS5ncm91cHM7XG5cbiAgY29uc3QgcmVzdWx0ID0ge1xuICAgIC4uLnN0YXRlLFxuICAgIC4uLmNvbnRlbnQsXG4gICAgZ3JvdXBzOiBncm91cHMsXG4gICAgaW50ZXJhY3Rpb25TdGF0ZToge1xuICAgICAgLi4uc3RhdGUuaW50ZXJhY3Rpb25TdGF0ZSxcbiAgICAgIC4uLmNvbnRlbnQuaW50ZXJhY3Rpb25TdGF0ZSxcbiAgICAgIGlzc3VlTmF2aWdhdGlvbkRvbmU6IHRydWUsXG4gICAgfSxcbiAgfTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==
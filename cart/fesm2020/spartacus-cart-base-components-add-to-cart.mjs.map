{"version":3,"file":"spartacus-cart-base-components-add-to-cart.mjs","sources":["../../../feature-libs/cart/base/components/add-to-cart/add-to-cart.component.ts","../../../feature-libs/cart/base/components/add-to-cart/add-to-cart.component.html","../../../feature-libs/cart/base/components/add-to-cart/add-to-cart.module.ts","../../../feature-libs/cart/base/components/add-to-cart/public_api.ts","../../../feature-libs/cart/base/components/add-to-cart/spartacus-cart-base-components-add-to-cart.ts"],"sourcesContent":["/*\n * SPDX-FileCopyrightText: 2022 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport {\n  ChangeDetectionStrategy,\n  ChangeDetectorRef,\n  Component,\n  Input,\n  OnDestroy,\n  OnInit,\n  Optional,\n} from '@angular/core';\nimport { UntypedFormControl, UntypedFormGroup } from '@angular/forms';\nimport {\n  ActiveCartFacade,\n  CartItemComponentOptions,\n  CartUiEventAddToCart,\n} from '@spartacus/cart/base/root';\nimport {\n  CmsAddToCartComponent,\n  EventService,\n  isNotNullable,\n  Product,\n} from '@spartacus/core';\nimport {\n  CmsComponentData,\n  CurrentProductService,\n  ProductListItemContext,\n} from '@spartacus/storefront';\nimport { Observable, Subscription } from 'rxjs';\nimport { filter, map, take } from 'rxjs/operators';\n\n@Component({\n  selector: 'cx-add-to-cart',\n  templateUrl: './add-to-cart.component.html',\n  changeDetection: ChangeDetectionStrategy.OnPush,\n})\nexport class AddToCartComponent implements OnInit, OnDestroy {\n  @Input() productCode: string;\n  @Input() showQuantity = true;\n  @Input() options: CartItemComponentOptions;\n  /**\n   * As long as we do not support #5026, we require product input, as we need\n   *  a reference to the product model to fetch the stock data.\n   */\n  @Input() product: Product;\n\n  maxQuantity: number;\n\n  hasStock: boolean = false;\n  inventoryThreshold: boolean = false;\n\n  showInventory$: Observable<boolean | undefined> | undefined =\n    this.component?.data$.pipe(map((data) => data.inventoryDisplay));\n\n  quantity = 1;\n\n  subscription: Subscription;\n\n  addToCartForm = new UntypedFormGroup({\n    quantity: new UntypedFormControl(1, { updateOn: 'blur' }),\n  });\n\n  constructor(\n    protected currentProductService: CurrentProductService,\n    protected cd: ChangeDetectorRef,\n    protected activeCartService: ActiveCartFacade,\n    protected component: CmsComponentData<CmsAddToCartComponent>,\n    protected eventService: EventService,\n    @Optional() protected productListItemContext?: ProductListItemContext\n  ) {}\n\n  ngOnInit() {\n    if (this.product) {\n      this.productCode = this.product.code ?? '';\n      this.setStockInfo(this.product);\n      this.cd.markForCheck();\n    } else if (this.productCode) {\n      // force hasStock and quantity for the time being, as we do not have more info:\n      this.quantity = 1;\n      this.hasStock = true;\n      this.cd.markForCheck();\n    } else {\n      this.subscription = (\n        this.productListItemContext\n          ? this.productListItemContext.product$\n          : this.currentProductService.getProduct()\n      )\n        .pipe(filter(isNotNullable))\n        .subscribe((product) => {\n          this.productCode = product.code ?? '';\n          this.setStockInfo(product);\n          this.cd.markForCheck();\n        });\n    }\n  }\n\n  protected setStockInfo(product: Product): void {\n    this.quantity = 1;\n    this.hasStock = Boolean(product.stock?.stockLevelStatus !== 'outOfStock');\n\n    this.inventoryThreshold = product.stock?.isValueRounded ?? false;\n\n    if (this.hasStock && product.stock?.stockLevel) {\n      this.maxQuantity = product.stock.stockLevel;\n    }\n\n    if (this.productListItemContext) {\n      this.showQuantity = false;\n    }\n  }\n\n  /**\n   * In specific scenarios, we need to omit displaying the stock level or append a plus to the value.\n   * When backoffice forces a product to be in stock, omit showing the stock level.\n   * When product stock level is limited by a threshold value, append '+' at the end.\n   * When out of stock, display no numerical value.\n   */\n  getInventory(): string {\n    if (this.hasStock) {\n      const quantityDisplay = this.maxQuantity\n        ? this.maxQuantity.toString()\n        : '';\n      return this.inventoryThreshold ? quantityDisplay + '+' : quantityDisplay;\n    } else {\n      return '';\n    }\n  }\n\n  updateCount(value: number): void {\n    this.quantity = value;\n  }\n\n  addToCart() {\n    const quantity = this.addToCartForm.get('quantity')?.value;\n    if (!this.productCode || quantity <= 0) {\n      return;\n    }\n\n    this.activeCartService\n      .getEntries()\n      .pipe(take(1))\n      .subscribe((cartEntries) => {\n        this.activeCartService.addEntry(this.productCode, quantity);\n\n        // A CartUiEventAddToCart is dispatched.  This event is intended for the UI\n        // responsible to provide feedback about what was added to the cart, like\n        // the added to cart dialog.\n        //\n        // Because we call activeCartService.getEntries() before, we can be sure the\n        // cart library is loaded already and that the event listener exists.\n        this.eventService.dispatch(\n          this.createCartUiEventAddToCart(\n            this.productCode,\n            quantity,\n            cartEntries.length\n          )\n        );\n      });\n  }\n\n  protected createCartUiEventAddToCart(\n    productCode: string,\n    quantity: number,\n    numberOfEntriesBeforeAdd: number\n  ) {\n    const newEvent = new CartUiEventAddToCart();\n    newEvent.productCode = productCode;\n    newEvent.quantity = quantity;\n    newEvent.numberOfEntriesBeforeAdd = numberOfEntriesBeforeAdd;\n    return newEvent;\n  }\n\n  ngOnDestroy() {\n    if (this.subscription) {\n      this.subscription.unsubscribe();\n    }\n  }\n}\n","<form *ngIf=\"productCode\" [formGroup]=\"addToCartForm\" (submit)=\"addToCart()\">\n  <div class=\"quantity\" *ngIf=\"showQuantity\">\n    <label>{{ 'addToCart.quantity' | cxTranslate }}</label>\n    <div class=\"cx-counter-stock\">\n      <cx-item-counter\n        *ngIf=\"hasStock\"\n        [max]=\"maxQuantity\"\n        [control]=\"addToCartForm.get('quantity')\"\n      ></cx-item-counter>\n\n      <span class=\"info\">\n        <span *ngIf=\"showInventory$ | async\">{{ getInventory() }}</span>\n        {{\n          hasStock\n            ? ('addToCart.inStock' | cxTranslate)\n            : ('addToCart.outOfStock' | cxTranslate)\n        }}</span\n      >\n    </div>\n  </div>\n\n  <button\n    *ngIf=\"hasStock\"\n    [ngClass]=\"\n      options?.displayAddToCart\n        ? 'link cx-action-link'\n        : 'btn btn-primary btn-block'\n    \"\n    type=\"submit\"\n    [disabled]=\"quantity <= 0 || quantity > maxQuantity\"\n  >\n    {{ options?.addToCartString ?? ('addToCart.addToCart' | cxTranslate) }}\n  </button>\n</form>\n","/*\n * SPDX-FileCopyrightText: 2022 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { CommonModule } from '@angular/common';\nimport { NgModule } from '@angular/core';\nimport { ReactiveFormsModule } from '@angular/forms';\nimport { CmsConfig, I18nModule, provideDefaultConfig } from '@spartacus/core';\nimport { ItemCounterModule } from '@spartacus/storefront';\nimport { AddToCartComponent } from './add-to-cart.component';\n\n@NgModule({\n  imports: [CommonModule, ReactiveFormsModule, I18nModule, ItemCounterModule],\n  providers: [\n    provideDefaultConfig(<CmsConfig>{\n      cmsComponents: {\n        ProductAddToCartComponent: {\n          component: AddToCartComponent,\n          data: {\n            inventoryDisplay: false,\n          },\n        },\n      },\n    }),\n  ],\n  declarations: [AddToCartComponent],\n  exports: [AddToCartComponent],\n})\nexport class AddToCartModule {}\n","/*\n * SPDX-FileCopyrightText: 2022 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './add-to-cart.component';\nexport * from './add-to-cart.module';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":"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"}
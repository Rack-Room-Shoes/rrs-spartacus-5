import { __decorate } from "tslib";
/*
 * SPDX-FileCopyrightText: 2022 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { Effect, ofType } from '@ngrx/effects';
import { select } from '@ngrx/store';
import { CartActions, getCartIdByUserId, MultiCartSelectors, } from '@spartacus/cart/base/core';
import { CartType } from '@spartacus/cart/base/root';
import { isNotUndefined, normalizeHttpError, SiteContextActions, } from '@spartacus/core';
import { EMPTY, from } from 'rxjs';
import { catchError, concatMap, filter, map, switchMap, withLatestFrom, } from 'rxjs/operators';
import { WishListActions } from '../actions';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "@spartacus/cart/base/core";
import * as i3 from "@spartacus/core";
import * as i4 from "@ngrx/store";
export class WishListEffects {
    constructor(actions$, cartConnector, userIdService, store) {
        this.actions$ = actions$;
        this.cartConnector = cartConnector;
        this.userIdService = userIdService;
        this.store = store;
        this.createWishList$ = this.actions$.pipe(ofType(WishListActions.CREATE_WISH_LIST), map((action) => action.payload), switchMap((payload) => {
            return this.cartConnector.create(payload.userId).pipe(switchMap((cart) => {
                return this.cartConnector
                    .save(payload.userId, cart.code ?? '', payload.name, payload.description)
                    .pipe(switchMap((savedCart) => [
                    new WishListActions.CreateWishListSuccess({
                        cart: savedCart,
                        cartId: getCartIdByUserId(savedCart, payload.userId),
                    }),
                ]), catchError((error) => from([
                    new WishListActions.CreateWishListFail({
                        cartId: cart.code ?? '',
                        error: normalizeHttpError(error),
                    }),
                ])));
            }));
        }));
        this.loadWishList$ = this.actions$.pipe(ofType(WishListActions.LOAD_WISH_LIST), map((action) => action.payload), concatMap((payload) => {
            const { userId, cartId } = payload;
            return this.cartConnector.loadAll(userId).pipe(switchMap((carts) => {
                const wishListName = cartId;
                const wishList = carts.find((cart) => cart.name === wishListName);
                const actions = [];
                actions.push(wishList
                    ? new WishListActions.LoadWishListSuccess({
                        cart: wishList,
                        cartId: getCartIdByUserId(wishList, userId),
                    })
                    : new WishListActions.CreateWishList({
                        userId,
                        name: wishListName,
                    }));
                // remove temp wishlist, which id is whishlist name
                actions.push(new CartActions.RemoveCart({ cartId: wishListName }));
                return actions;
            }), catchError((error) => from([
                new WishListActions.LoadWishListFail({
                    cartId: cartId,
                    error: normalizeHttpError(error),
                }),
            ])));
        }));
        this.resetWishList$ = this.actions$.pipe(ofType(SiteContextActions.LANGUAGE_CHANGE, SiteContextActions.CURRENCY_CHANGE), withLatestFrom(this.userIdService.getUserId(), this.store.pipe(filter((store) => !!store.cart), select(MultiCartSelectors.getCartIdByTypeFactory(CartType.WISH_LIST)))), switchMap(([, userId, wishListId]) => {
            if (Boolean(wishListId)) {
                return this.cartConnector.load(userId, wishListId).pipe(switchMap((wishList) => [
                    new WishListActions.LoadWishListSuccess({
                        cart: wishList ?? {},
                        cartId: getCartIdByUserId(wishList, userId),
                    }),
                ]), catchError((error) => from([
                    new WishListActions.LoadWishListFail({
                        cartId: wishListId,
                        error: normalizeHttpError(error),
                    }),
                ])));
            }
            return EMPTY;
        }));
        this.setWishListId$ = this.actions$.pipe(ofType(WishListActions.CREATE_WISH_LIST_SUCCESS, WishListActions.LOAD_WISH_LIST_SUCCESS), map((action) => {
            switch (action.type) {
                case WishListActions.CREATE_WISH_LIST_SUCCESS:
                case WishListActions.LOAD_WISH_LIST_SUCCESS: {
                    return new CartActions.SetCartTypeIndex({
                        cartType: CartType.WISH_LIST,
                        cartId: action.meta
                            .entityId,
                    });
                }
            }
        }), filter(isNotUndefined));
        this.setWishListData$ = this.actions$.pipe(ofType(WishListActions.CREATE_WISH_LIST_SUCCESS, WishListActions.LOAD_WISH_LIST_SUCCESS), map((action) => {
            switch (action.type) {
                case WishListActions.CREATE_WISH_LIST_SUCCESS:
                case WishListActions.LOAD_WISH_LIST_SUCCESS: {
                    return new CartActions.SetCartData({
                        cart: action.payload.cart,
                        cartId: action.payload.cartId,
                    });
                }
            }
        }), filter(isNotUndefined));
    }
}
WishListEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: WishListEffects, deps: [{ token: i1.Actions }, { token: i2.CartConnector }, { token: i3.UserIdService }, { token: i4.Store }], target: i0.ɵɵFactoryTarget.Injectable });
WishListEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: WishListEffects });
__decorate([
    Effect()
], WishListEffects.prototype, "createWishList$", void 0);
__decorate([
    Effect()
], WishListEffects.prototype, "loadWishList$", void 0);
__decorate([
    Effect()
], WishListEffects.prototype, "resetWishList$", void 0);
__decorate([
    Effect()
], WishListEffects.prototype, "setWishListId$", void 0);
__decorate([
    Effect()
], WishListEffects.prototype, "setWishListData$", void 0);
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.3", ngImport: i0, type: WishListEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.CartConnector }, { type: i3.UserIdService }, { type: i4.Store }]; }, propDecorators: { createWishList$: [], loadWishList$: [], resetWishList$: [], setWishListId$: [], setWishListData$: [] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lzaC1saXN0LmVmZmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9jYXJ0L3dpc2gtbGlzdC9jb3JlL3N0b3JlL2VmZmVjdHMvd2lzaC1saXN0LmVmZmVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFXLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEQsT0FBTyxFQUFVLE1BQU0sRUFBUyxNQUFNLGFBQWEsQ0FBQztBQUNwRCxPQUFPLEVBQ0wsV0FBVyxFQUVYLGlCQUFpQixFQUNqQixrQkFBa0IsR0FFbkIsTUFBTSwyQkFBMkIsQ0FBQztBQUNuQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDckQsT0FBTyxFQUNMLGNBQWMsRUFDZCxrQkFBa0IsRUFDbEIsa0JBQWtCLEdBR25CLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDL0MsT0FBTyxFQUNMLFVBQVUsRUFDVixTQUFTLEVBQ1QsTUFBTSxFQUNOLEdBQUcsRUFDSCxTQUFTLEVBQ1QsY0FBYyxHQUNmLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLFlBQVksQ0FBQzs7Ozs7O0FBRzdDLE1BQU0sT0FBTyxlQUFlO0lBZ0sxQixZQUNVLFFBQWlCLEVBQ2pCLGFBQTRCLEVBQzVCLGFBQTRCLEVBQzVCLEtBQWdDO1FBSGhDLGFBQVEsR0FBUixRQUFRLENBQVM7UUFDakIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsVUFBSyxHQUFMLEtBQUssQ0FBMkI7UUFsSzFDLG9CQUFlLEdBRVgs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QUk7d0JBQ3pCLE1BQU0sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU07cUJBQzlCLENBQUMsQ0FBQztpQkFDSjthQUNGO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUN2QixDQUFDO0lBT0MsQ0FBQzs7NEdBcktPLGVBQWU7Z0hBQWYsZUFBZTtBQUUxQjtJQURDLE1BQU0sRUFBRTt3REFtQ1A7QUFHRjtJQURDLE1BQU0sRUFBRTtzREF5Q1A7QUFHRjtJQURDLE1BQU0sRUFBRTt1REFvQ1A7QUFHRjtJQURDLE1BQU0sRUFBRTt1REFtQlA7QUFHRjtJQURDLE1BQU0sRUFBRTt5REFrQlA7MkZBOUpTLGVBQWU7a0JBRDNCLFVBQVU7MEtBR1QsZUFBZSxNQXFDZixhQUFhLE1BMkNiLGNBQWMsTUFzQ2QsY0FBYyxNQXFCZCxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMiBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25zLCBFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHsgQWN0aW9uLCBzZWxlY3QsIFN0b3JlIH0gZnJvbSAnQG5ncngvc3RvcmUnO1xuaW1wb3J0IHtcbiAgQ2FydEFjdGlvbnMsXG4gIENhcnRDb25uZWN0b3IsXG4gIGdldENhcnRJZEJ5VXNlcklkLFxuICBNdWx0aUNhcnRTZWxlY3RvcnMsXG4gIFN0YXRlV2l0aE11bHRpQ2FydCxcbn0gZnJvbSAnQHNwYXJ0YWN1cy9jYXJ0L2Jhc2UvY29yZSc7XG5pbXBvcnQgeyBDYXJ0VHlwZSB9IGZyb20gJ0BzcGFydGFjdXMvY2FydC9iYXNlL3Jvb3QnO1xuaW1wb3J0IHtcbiAgaXNOb3RVbmRlZmluZWQsXG4gIG5vcm1hbGl6ZUh0dHBFcnJvcixcbiAgU2l0ZUNvbnRleHRBY3Rpb25zLFxuICBTdGF0ZVV0aWxzLFxuICBVc2VySWRTZXJ2aWNlLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgRU1QVFksIGZyb20sIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGNhdGNoRXJyb3IsXG4gIGNvbmNhdE1hcCxcbiAgZmlsdGVyLFxuICBtYXAsXG4gIHN3aXRjaE1hcCxcbiAgd2l0aExhdGVzdEZyb20sXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFdpc2hMaXN0QWN0aW9ucyB9IGZyb20gJy4uL2FjdGlvbnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgV2lzaExpc3RFZmZlY3RzIHtcbiAgQEVmZmVjdCgpXG4gIGNyZWF0ZVdpc2hMaXN0JDogT2JzZXJ2YWJsZTxcbiAgICBXaXNoTGlzdEFjdGlvbnMuQ3JlYXRlV2lzaExpc3RTdWNjZXNzIHwgV2lzaExpc3RBY3Rpb25zLkNyZWF0ZVdpc2hMaXN0RmFpbFxuICA+ID0gdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgIG9mVHlwZShXaXNoTGlzdEFjdGlvbnMuQ1JFQVRFX1dJU0hfTElTVCksXG4gICAgbWFwKChhY3Rpb246IFdpc2hMaXN0QWN0aW9ucy5DcmVhdGVXaXNoTGlzdCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgIHN3aXRjaE1hcCgocGF5bG9hZCkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuY2FydENvbm5lY3Rvci5jcmVhdGUocGF5bG9hZC51c2VySWQpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoY2FydCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGlzLmNhcnRDb25uZWN0b3JcbiAgICAgICAgICAgIC5zYXZlKFxuICAgICAgICAgICAgICBwYXlsb2FkLnVzZXJJZCxcbiAgICAgICAgICAgICAgY2FydC5jb2RlID8/ICcnLFxuICAgICAgICAgICAgICBwYXlsb2FkLm5hbWUsXG4gICAgICAgICAgICAgIHBheWxvYWQuZGVzY3JpcHRpb25cbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICBzd2l0Y2hNYXAoKHNhdmVkQ2FydCkgPT4gW1xuICAgICAgICAgICAgICAgIG5ldyBXaXNoTGlzdEFjdGlvbnMuQ3JlYXRlV2lzaExpc3RTdWNjZXNzKHtcbiAgICAgICAgICAgICAgICAgIGNhcnQ6IHNhdmVkQ2FydCxcbiAgICAgICAgICAgICAgICAgIGNhcnRJZDogZ2V0Q2FydElkQnlVc2VySWQoc2F2ZWRDYXJ0LCBwYXlsb2FkLnVzZXJJZCksXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICAgICAgICBmcm9tKFtcbiAgICAgICAgICAgICAgICAgIG5ldyBXaXNoTGlzdEFjdGlvbnMuQ3JlYXRlV2lzaExpc3RGYWlsKHtcbiAgICAgICAgICAgICAgICAgICAgY2FydElkOiBjYXJ0LmNvZGUgPz8gJycsXG4gICAgICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IpLFxuICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgbG9hZFdpc2hMaXN0JDogT2JzZXJ2YWJsZTxcbiAgICB8IFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3RTdWNjZXNzXG4gICAgfCBDYXJ0QWN0aW9ucy5SZW1vdmVDYXJ0XG4gICAgfCBXaXNoTGlzdEFjdGlvbnMuQ3JlYXRlV2lzaExpc3RcbiAgICB8IFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3RGYWlsXG4gID4gPSB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgb2ZUeXBlKFdpc2hMaXN0QWN0aW9ucy5MT0FEX1dJU0hfTElTVCksXG4gICAgbWFwKChhY3Rpb246IFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3QpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICBjb25jYXRNYXAoKHBheWxvYWQpID0+IHtcbiAgICAgIGNvbnN0IHsgdXNlcklkLCBjYXJ0SWQgfSA9IHBheWxvYWQ7XG4gICAgICByZXR1cm4gdGhpcy5jYXJ0Q29ubmVjdG9yLmxvYWRBbGwodXNlcklkKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKGNhcnRzKSA9PiB7XG4gICAgICAgICAgY29uc3Qgd2lzaExpc3ROYW1lID0gY2FydElkO1xuICAgICAgICAgIGNvbnN0IHdpc2hMaXN0ID0gY2FydHMuZmluZCgoY2FydCkgPT4gY2FydC5uYW1lID09PSB3aXNoTGlzdE5hbWUpO1xuICAgICAgICAgIGNvbnN0IGFjdGlvbnMgPSBbXTtcbiAgICAgICAgICBhY3Rpb25zLnB1c2goXG4gICAgICAgICAgICB3aXNoTGlzdFxuICAgICAgICAgICAgICA/IG5ldyBXaXNoTGlzdEFjdGlvbnMuTG9hZFdpc2hMaXN0U3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgICBjYXJ0OiB3aXNoTGlzdCxcbiAgICAgICAgICAgICAgICAgIGNhcnRJZDogZ2V0Q2FydElkQnlVc2VySWQod2lzaExpc3QsIHVzZXJJZCksXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgOiBuZXcgV2lzaExpc3RBY3Rpb25zLkNyZWF0ZVdpc2hMaXN0KHtcbiAgICAgICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgICAgIG5hbWU6IHdpc2hMaXN0TmFtZSxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgICAgLy8gcmVtb3ZlIHRlbXAgd2lzaGxpc3QsIHdoaWNoIGlkIGlzIHdoaXNobGlzdCBuYW1lXG4gICAgICAgICAgYWN0aW9ucy5wdXNoKG5ldyBDYXJ0QWN0aW9ucy5SZW1vdmVDYXJ0KHsgY2FydElkOiB3aXNoTGlzdE5hbWUgfSkpO1xuICAgICAgICAgIHJldHVybiBhY3Rpb25zO1xuICAgICAgICB9KSxcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+XG4gICAgICAgICAgZnJvbShbXG4gICAgICAgICAgICBuZXcgV2lzaExpc3RBY3Rpb25zLkxvYWRXaXNoTGlzdEZhaWwoe1xuICAgICAgICAgICAgICBjYXJ0SWQ6IGNhcnRJZCxcbiAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciksXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICBdKVxuICAgICAgICApXG4gICAgICApO1xuICAgIH0pXG4gICk7XG5cbiAgQEVmZmVjdCgpXG4gIHJlc2V0V2lzaExpc3QkOiBPYnNlcnZhYmxlPFxuICAgIFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3RTdWNjZXNzIHwgV2lzaExpc3RBY3Rpb25zLkxvYWRXaXNoTGlzdEZhaWxcbiAgPiA9IHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICBvZlR5cGUoXG4gICAgICBTaXRlQ29udGV4dEFjdGlvbnMuTEFOR1VBR0VfQ0hBTkdFLFxuICAgICAgU2l0ZUNvbnRleHRBY3Rpb25zLkNVUlJFTkNZX0NIQU5HRVxuICAgICksXG4gICAgd2l0aExhdGVzdEZyb20oXG4gICAgICB0aGlzLnVzZXJJZFNlcnZpY2UuZ2V0VXNlcklkKCksXG4gICAgICB0aGlzLnN0b3JlLnBpcGUoXG4gICAgICAgIGZpbHRlcigoc3RvcmUpID0+ICEhc3RvcmUuY2FydCksXG4gICAgICAgIHNlbGVjdChNdWx0aUNhcnRTZWxlY3RvcnMuZ2V0Q2FydElkQnlUeXBlRmFjdG9yeShDYXJ0VHlwZS5XSVNIX0xJU1QpKVxuICAgICAgKVxuICAgICksXG4gICAgc3dpdGNoTWFwKChbLCB1c2VySWQsIHdpc2hMaXN0SWRdKSA9PiB7XG4gICAgICBpZiAoQm9vbGVhbih3aXNoTGlzdElkKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5jYXJ0Q29ubmVjdG9yLmxvYWQodXNlcklkLCB3aXNoTGlzdElkKS5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgod2lzaExpc3QpID0+IFtcbiAgICAgICAgICAgIG5ldyBXaXNoTGlzdEFjdGlvbnMuTG9hZFdpc2hMaXN0U3VjY2Vzcyh7XG4gICAgICAgICAgICAgIGNhcnQ6IHdpc2hMaXN0ID8/IHt9LFxuICAgICAgICAgICAgICBjYXJ0SWQ6IGdldENhcnRJZEJ5VXNlcklkKHdpc2hMaXN0LCB1c2VySWQpLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgXSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+XG4gICAgICAgICAgICBmcm9tKFtcbiAgICAgICAgICAgICAgbmV3IFdpc2hMaXN0QWN0aW9ucy5Mb2FkV2lzaExpc3RGYWlsKHtcbiAgICAgICAgICAgICAgICBjYXJ0SWQ6IHdpc2hMaXN0SWQsXG4gICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciksXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgXSlcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfSlcbiAgKTtcblxuICBARWZmZWN0KClcbiAgc2V0V2lzaExpc3RJZCQ6IE9ic2VydmFibGU8Q2FydEFjdGlvbnMuU2V0Q2FydFR5cGVJbmRleD4gPSB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgb2ZUeXBlKFxuICAgICAgV2lzaExpc3RBY3Rpb25zLkNSRUFURV9XSVNIX0xJU1RfU1VDQ0VTUyxcbiAgICAgIFdpc2hMaXN0QWN0aW9ucy5MT0FEX1dJU0hfTElTVF9TVUNDRVNTXG4gICAgKSxcbiAgICBtYXAoKGFjdGlvbjogQWN0aW9uKSA9PiB7XG4gICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgV2lzaExpc3RBY3Rpb25zLkNSRUFURV9XSVNIX0xJU1RfU1VDQ0VTUzpcbiAgICAgICAgY2FzZSBXaXNoTGlzdEFjdGlvbnMuTE9BRF9XSVNIX0xJU1RfU1VDQ0VTUzoge1xuICAgICAgICAgIHJldHVybiBuZXcgQ2FydEFjdGlvbnMuU2V0Q2FydFR5cGVJbmRleCh7XG4gICAgICAgICAgICBjYXJ0VHlwZTogQ2FydFR5cGUuV0lTSF9MSVNULFxuICAgICAgICAgICAgY2FydElkOiAoYWN0aW9uIGFzIFN0YXRlVXRpbHMuRW50aXR5U3VjY2Vzc0FjdGlvbikubWV0YVxuICAgICAgICAgICAgICAuZW50aXR5SWQgYXMgc3RyaW5nLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSksXG4gICAgZmlsdGVyKGlzTm90VW5kZWZpbmVkKVxuICApO1xuXG4gIEBFZmZlY3QoKVxuICBzZXRXaXNoTGlzdERhdGEkOiBPYnNlcnZhYmxlPENhcnRBY3Rpb25zLlNldENhcnREYXRhPiA9IHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICBvZlR5cGUoXG4gICAgICBXaXNoTGlzdEFjdGlvbnMuQ1JFQVRFX1dJU0hfTElTVF9TVUNDRVNTLFxuICAgICAgV2lzaExpc3RBY3Rpb25zLkxPQURfV0lTSF9MSVNUX1NVQ0NFU1NcbiAgICApLFxuICAgIG1hcCgoYWN0aW9uOiBTdGF0ZVV0aWxzLkVudGl0eVN1Y2Nlc3NBY3Rpb24pID0+IHtcbiAgICAgIHN3aXRjaCAoYWN0aW9uLnR5cGUpIHtcbiAgICAgICAgY2FzZSBXaXNoTGlzdEFjdGlvbnMuQ1JFQVRFX1dJU0hfTElTVF9TVUNDRVNTOlxuICAgICAgICBjYXNlIFdpc2hMaXN0QWN0aW9ucy5MT0FEX1dJU0hfTElTVF9TVUNDRVNTOiB7XG4gICAgICAgICAgcmV0dXJuIG5ldyBDYXJ0QWN0aW9ucy5TZXRDYXJ0RGF0YSh7XG4gICAgICAgICAgICBjYXJ0OiBhY3Rpb24ucGF5bG9hZC5jYXJ0LFxuICAgICAgICAgICAgY2FydElkOiBhY3Rpb24ucGF5bG9hZC5jYXJ0SWQsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KSxcbiAgICBmaWx0ZXIoaXNOb3RVbmRlZmluZWQpXG4gICk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhY3Rpb25zJDogQWN0aW9ucyxcbiAgICBwcml2YXRlIGNhcnRDb25uZWN0b3I6IENhcnRDb25uZWN0b3IsXG4gICAgcHJpdmF0ZSB1c2VySWRTZXJ2aWNlOiBVc2VySWRTZXJ2aWNlLFxuICAgIHByaXZhdGUgc3RvcmU6IFN0b3JlPFN0YXRlV2l0aE11bHRpQ2FydD5cbiAgKSB7fVxufVxuIl19